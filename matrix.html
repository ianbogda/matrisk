<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M@TRISK - Pilotage des risques, des processus et de la conformit√©</title>
  <script src="https://cdn.jsdelivr.net/npm/docx/build/index.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvg@3.0.10/lib/umd.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/html-docx-js/dist/html-docx.js"></script>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
      :root {
          --cell-size: 84px;
          --grid-gap: 6px;
      }

      body {
          background: #f6f7f9;
      }

      .card {
          border: 0;
          border-radius: 14px;
      }

      .shadow-soft {
          box-shadow: 0 8px 24px rgba(0, 0, 0, .08);
      }

      .mono {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }

      .small-muted {
          color: #6c757d;
          font-size: .9rem;
      }

      .pill {
          border: 1px solid rgba(0, 0, 0, .12);
          border-radius: 999px;
          padding: .15rem .6rem;
          font-size: .85rem;
          background: #fff;
      }

      /* Matrix */
      .matrix-wrap {
          overflow-x: auto;
      }

      .matrix-area {
          display: grid;
          grid-template-columns: 1fr 320px;
          gap: 12px;
          align-items: start;
      }

      @media (max-width: 1200px) {
          .matrix-area {
              grid-template-columns: 1fr;
          }
      }

      .matrix {
          display: grid;
          grid-template-columns: 120px repeat(5, var(--cell-size));
          grid-template-rows: 48px repeat(5, var(--cell-size));
          gap: var(--grid-gap);
          align-items: stretch;
          min-width: calc(120px + 5*var(--cell-size) + 5*var(--grid-gap));
      }

      .m-head,
      .m-side {
          background: #fff;
          border-radius: 12px;
          border: 1px solid rgba(0, 0, 0, .08);
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 600;
      }

      .m-side {
          padding: 0 10px;
          justify-content: flex-start;
      }

      .cell {
          position: relative;
          border-radius: 12px;
          border: 1px solid rgba(0, 0, 0, .10);
          overflow: hidden;
          background: #fff;
      }

      .cell .score {
          position: absolute;
          bottom: 6px;
          right: 8px;
          font-size: .8rem;
          opacity: .7;
          font-weight: 600;
      }

      /* Heat colors */
      .heat-g {
          background: #cfe9d6;
      }

      .heat-y {
          background: #ffe8a3;
      }

      .heat-o {
          background: #ffc98a;
      }

      .heat-r {
          background: #ffb3b3;
      }

      /* Markers */
      .marker {
          position: absolute;
          width: 28px;
          height: 28px;
          border-radius: 999px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: .75rem;
          font-weight: 700;
          box-shadow: 0 8px 16px rgba(0, 0, 0, .12);
          user-select: none;
          cursor: pointer;
          border: 2px solid rgba(255, 255, 255, .9);
      }

      .marker.inherent {
          background: #0d6efd;
          color: #fff;
          left: 10px;
          top: 10px;
      }

      .marker.residual {
          background: #198754;
          color: #fff;
          left: 44px;
          top: 10px;
      }

      .marker.same {
          left: 28px;
      }

      .legend-dot {
          width: 12px;
          height: 12px;
          border-radius: 999px;
          display: inline-block;
          vertical-align: middle;
      }

      .dot-blue {
          background: #0d6efd;
      }

      .dot-green {
          background: #198754;
      }

      /* Filter list (right) */
      .risk-list {
          max-height: 420px;
          overflow: auto;
          border: 1px solid rgba(0, 0, 0, .08);
          border-radius: 12px;
          background: #fff;
      }

      .risk-item {
          display: flex;
          gap: 10px;
          align-items: flex-start;
          padding: 10px 12px;
          border-bottom: 1px solid rgba(0, 0, 0, .06);
      }

      .risk-item:last-child {
          border-bottom: 0;
      }

      .risk-item:hover {
          background: rgba(13, 110, 253, .04);
      }

      .risk-item .meta {
          flex: 1;
          cursor: pointer;
      }

      .risk-item .meta .title {
          font-weight: 600;
          line-height: 1.15;
      }

      .risk-item .meta .sub {
          font-size: .85rem;
          color: #6c757d;
      }

      .risk-item .tag {
          white-space: nowrap;
      }

      /* Table */
      .table thead th {
          white-space: nowrap;
      }

      .nowrap {
          white-space: nowrap;
      }

      .required::after {
          content: " *";
          color: #dc3545;
      }

      /* Selected highlight in list */
      .risk-item.selected {
          outline: 2px solid rgba(13, 110, 253, .35);
          outline-offset: -2px;
          background: rgba(13, 110, 253, .06);
      }

      .mp-shape {
          cursor: pointer;
          filter: drop-shadow(0 6px 12px rgba(0, 0, 0, .10));
      }

      .mp-label {
          font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }

      .mp-row-selected {
          outline: 2px solid rgba(13, 110, 253, .35);
          outline-offset: -2px;
          background: rgba(13, 110, 253, .06);
      }

      .flow-step {
          position: relative;
      }

      .flow-step::after {
          content: "";
          position: absolute;
          left: 50%;
          bottom: -10px;
          width: 2px;
          height: 16px;
          background: rgba(0, 0, 0, .15);
          transform: translateX(-50%);
      }

      .flow-last::after {
          display: none;
      }

      .risk-badge {
          cursor: pointer;
      }

      .step-card {
          border: 1px solid rgba(0, 0, 0, .10);
          border-radius: 12px;
          padding: 8px 10px;
          background: #fff;
      }

      .step-actions button {
          padding: 2px 8px;
      }

      .word-export {
          font-family: Calibri, Arial, sans-serif;
          font-size: 11pt;
      }

      .word-export h1 {
          font-size: 20pt;
      }

      .word-export h2 {
          font-size: 16pt;
      }

      .word-export h3 {
          font-size: 14pt;
      }

      .word-export table {
          width: 100%;
          border-collapse: collapse;
          margin-bottom: 16px;
      }

      .word-export th,
      .word-export td {
          border: 1px solid #333;
          padding: 4px 6px;
      }

      .word-export .page-break {
          page-break-before: always;
      }

      .word-export svg {
          max-width: 100%;
          height: auto;
          margin: 12px 0 20px 0;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
<div class="container-fluid py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
        <div>
            <h1 class="h3 mb-1">M@TRISK</h1>
            <div class="small-muted">Pilotage des risques, des processus et de la conformit√©</div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" id="btnExportPdf">Export PDF</button>
            <button class="btn btn-outline-primary" id="btnExportWord">Export Word</button>

            <button class="btn btn-outline-secondary" id="btnExport">Exporter JSON</button>
            <button class="btn btn-outline-secondary" id="btnImport">Importer JSON</button>
            <input type="file" id="fileImport" accept="application/json" class="d-none">
            <button class="btn btn-outline-danger" id="btnReset">R√©initialiser</button>

        </div>
    </div>
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-macroprocessus" type="button">
                Macroprocessus
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-processus" type="button">
                Processus
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-procedures" type="button">
                Proc√©dures
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-risques" type="button">
                Risques
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-domains">
                Ma√Ætrise des domaines
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mp-domains">
                Macroprocessus √ó Domaines
            </button>
        </li>

    </ul>


    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-macroprocessus">
            <div class="row g-3">
                <div class="col-xl-4">
                    <div class="card shadow-soft p-3">
                        <h5>Macroprocessus</h5>

                        <label class="form-label">Type</label>
                        <select class="form-select" id="mpType">
                            <option value="P">Pilotage</option>
                            <option value="M">M√©tier</option>
                            <option value="S">Support</option>
                        </select>

                        <label class="form-label mt-2">Code</label>
                        <input class="form-control" id="mpCode" placeholder="MPP01">

                        <label class="form-label mt-2">Nom</label>
                        <input class="form-control" id="mpName">

                        <label class="form-label mt-2">Responsable</label>
                        <input class="form-control" id="mpOwner">

                        <label class="form-label mt-2">Objectifs</label>
                        <textarea class="form-control" id="mpObjectives" rows="2"></textarea>

                        <button class="btn btn-primary mt-3" id="btnSaveMP">Enregistrer</button>
                    </div>
                </div>

                <div class="col-xl-8">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h5 class="mb-0">Cartographie des macroprocessus</h5>
                            <div class="small text-muted">Pilotage (haut) ¬∑ M√©tier (milieu) ¬∑ Support (bas)</div>
                        </div>

                        <div class="border rounded-4 p-2 bg-white">
                            <svg id="mpMap" viewBox="0 0 1200 720" width="100%" height="460" role="img" aria-label="Cartographie des macroprocessus">
                                <!-- Fond zones -->
                                <rect x="10" y="10" width="1180" height="210" rx="20" fill="#eef5ff"></rect>
                                <rect x="10" y="255" width="1180" height="210" rx="20" fill="#f3fff0"></rect>
                                <rect x="10" y="500" width="1180" height="210" rx="20" fill="#fff6ea"></rect>

                                <!-- Titres zones -->
                                <text x="30" y="55" font-size="26" font-weight="700" fill="#0d6efd">PILOTAGE (P)</text>
                                <text x="30" y="300" font-size="26" font-weight="700" fill="#198754">M√âTIER (M)</text>
                                <text x="30" y="545" font-size="26" font-weight="700" fill="#fd7e14">SUPPORT (S)</text>

                                <!-- Conteneurs dynamiques -->
                                <g id="mpPilotage"></g>
                                <g id="mpMetier"></g>
                                <g id="mpSupport"></g>
                            </svg>
                        </div>

                    </div>

                    <div class="card shadow-soft p-3 mt-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h5 class="mb-0">Liste des macroprocessus</h5>
                            <input class="form-control form-control-sm" id="mpSearch" style="max-width:320px;" placeholder="Rechercher (code, nom, type)‚Ä¶">
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm align-middle mb-0">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Type</th>
                                        <th>Nom</th>
                                        <th>Responsable</th>
                                        <th class="nowrap">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="mpTbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

        </div>
        <div class="tab-pane fade" id="tab-processus">
            <div class="row g-3">
                <!-- Colonne gauche : liste des processus du macroprocessus s√©lectionn√© -->
                <div class="col-12 col-xl-4">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h5 class="mb-0">Processus</h5>
                            <span class="pill">MP <span class="mono" id="procMpBadge">‚Äî</span></span>
                        </div>

                        <div class="small text-muted mt-1">
                            Double-clic sur un macroprocessus = ouverture ici + filtrage automatique.
                        </div>

                        <div class="mt-2">
                            <label class="form-label mb-1">Macroprocessus</label>
                            <select class="form-select form-select-sm" id="procMpSelect"></select>
                        </div>

                        <input class="form-control form-control-sm mt-2" id="procSearch" placeholder="Rechercher (code, nom)‚Ä¶">

                        <div class="risk-list mt-2" id="procList" style="max-height:520px;"></div>

                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-primary" id="btnNewProcess">Nouveau</button>
                            <button class="btn btn-sm btn-outline-secondary" id="btnClearProcess">Vider</button>
                        </div>
                    </div>
                </div>

                <!-- Colonne droite : fiche ISO du processus -->
                <div class="col-12 col-xl-8">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                            <h5 class="mb-0">Fiche processus</h5>
                            <span class="pill">Risques <span class="mono" id="procRiskCount">0</span></span>
                            <span class="pill">Code <span class="mono" id="procCodeBadge">‚Äî</span></span>
                        </div>


                        <div class="row g-2 mt-1">
                            <div class="col-md-4">
                                <label class="form-label required">Code</label>
                                <input class="form-control" id="procId" placeholder="MPP01-001">
                            </div>
                            <div class="col-md-8">
                                <label class="form-label required">Nom du processus</label>
                                <input class="form-control" id="procName" placeholder="Gestion des risques mails">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Pilote</label>
                                <input class="form-control" id="procPilot" placeholder="SGE">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Finalit√© / Objectif</label>
                                <input class="form-control" id="procPurpose" placeholder="Ma√Ætriser les risques de la proc√©dure mails">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">P√©rim√®tre</label>
                                <input class="form-control" id="procScope" placeholder="EPLE ‚Äì secr√©tariat / gestion / SRH‚Ä¶">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Entr√©es (inputs)</label>
                                <textarea class="form-control" id="procInputs" rows="2" placeholder="Courriels entrants, demandes usagers, pi√®ces jointes‚Ä¶"></textarea>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Sorties (outputs)</label>
                                <textarea class="form-control" id="procOutputs" rows="2" placeholder="Courriels class√©s, d√©cisions trac√©es, preuves auditables‚Ä¶"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Ressources / moyens</label>
                                <textarea class="form-control" id="procResources" rows="2" placeholder="Outlook, arborescence partag√©e, droits, formations‚Ä¶"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Interactions (amont / aval)</label>
                                <textarea class="form-control" id="procInteractions" rows="2" placeholder="Amont: direction / enseignants‚Ä¶ Aval: compta, RH, vie scolaire‚Ä¶"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Indicateurs / KPI</label>
                                <textarea class="form-control" id="procKpi" rows="2" placeholder="% mails class√©s < 30j, nb √©carts inspection, d√©lai r√©ponse‚Ä¶"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Risques & ma√Ætrises (liens)</label>
                                <textarea class="form-control" id="procRisks" rows="2" placeholder="R1, R3‚Ä¶ + contr√¥les C1‚Ä¶ (on reliera automatiquement ensuite)"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Documents applicables</label>
                                <textarea class="form-control" id="procDocs" rows="2" placeholder="Proc√©dure mails v1.0, charte SI, RGPD‚Ä¶"></textarea>
                            </div>

                            <div class="col-12 d-flex gap-2 mt-2">
                                <button class="btn btn-outline-secondary" id="btnViewProcedures">Voir proc√©dures</button>

                                <button class="btn btn-primary" id="btnSaveProcess">Enregistrer</button>
                                <button class="btn btn-outline-danger" id="btnDeleteProcess">Supprimer</button>
                            </div>
                        </div>
                    </div>
                    <div class="card shadow-soft p-3 ">
                        <h6 class="mb-2">Risques du processus</h6>
                        <div id="processRiskTable"></div>
                    </div>

                </div>
            </div>

        </div>
        <div class="tab-pane fade" id="tab-procedures">
            <div class="row g-3">
                <!-- Gauche: s√©lection Processus + liste Proc√©dures -->
                <div class="col-12 col-xl-4">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <h5 class="mb-0">Proc√©dures</h5>
                            <span class="pill">Processus <span class="mono" id="proc2ProcessBadge">‚Äî</span></span>
                        </div>

                        <div class="mt-2">
                            <label class="form-label mb-1">Processus</label>
                            <select class="form-select form-select-sm" id="proc2ProcessSelect"></select>
                        </div>

                        <input class="form-control form-control-sm mt-2" id="proc2Search" placeholder="Rechercher proc√©dure‚Ä¶">

                        <div class="risk-list mt-2" id="proc2List" style="max-height:520px;"></div>

                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-sm btn-primary" id="btnNewProcedure">Nouvelle</button>
                            <button class="btn btn-sm btn-outline-secondary" id="btnClearProcedure">Vider</button>
                        </div>
                    </div>
                </div>

                <!-- Droite: fiche proc√©dure + logigramme -->
                <div class="col-12 col-xl-8">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                            <h5 class="mb-0">Logigramme ‚Äì Qui ? / Fait quoi ? / Comment ?</h5>
                            <span class="pill">Proc√©dure <span class="mono" id="proc2Badge">‚Äî</span></span>
                        </div>

                        <div class="row g-2 mt-2">
                            <div class="col-md-4">
                                <label class="form-label required">ID</label>
                                <input class="form-control" id="proc2Id" placeholder="PROC-MAILS">
                            </div>
                            <div class="col-md-5">
                                <label class="form-label required">Nom</label>
                                <input class="form-control" id="proc2Name" placeholder="Proc√©dure de gestion des mails">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Version</label>
                                <input class="form-control" id="proc2Version" placeholder="1.0">
                            </div>

                            <div class="col-12 d-flex gap-2 mt-1">
                                <button class="btn btn-outline-secondary d-none" id="btnBackToProcedure">
                                    ‚Üê Retour √† la proc√©dure
                                </button>

                                <button class="btn btn-primary" id="btnSaveProcedure">Enregistrer</button>
                                <button class="btn btn-outline-danger" id="btnDeleteProcedure">Supprimer</button>
                                <button class="btn btn-outline-secondary ms-auto" id="btnAddStep">+ √âtape</button>
                            </div>
                        </div>

                        <hr class="my-3">

                        <!-- Editeur simple des √©tapes -->
                        <div id="proc2StepsEditor" class="mb-3"></div>

                        <!-- Logigramme 3 colonnes -->
                        <div class="border rounded-4 bg-white p-2">
                            <div class="table-responsive">
                                <table class="table table-sm align-middle mb-0" id="proc2FlowTable">
                                    <thead>
                                        <tr>
                                            <th style="width:22%;">Qui ?</th>
                                            <th style="width:40%;">Fait quoi ?</th>
                                            <th style="width:38%;">Comment ?</th>
                                        </tr>
                                    </thead>
                                    <tbody id="proc2FlowBody"></tbody>
                                </table>
                            </div>
                        </div>

                        <div class="small text-muted mt-2">
                            Les risques (R‚Ä¶) affich√©s sur les √©tapes sont cliquables : ouverture de la fiche Risque.
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div class="tab-pane fade" id="tab-risques">
            <div class="row g-3">
                <!-- Form -->
                <div class="col-12 col-xl-4">
                    <div class="card shadow-soft p-3">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h2 class="h5 mb-0">Fiche risque</h2>
                            <span class="pill">Score <span class="mono" id="scoreNow">9</span> ¬∑ Niveau <span class="mono" id="levelNow">Significatif</span></span>
                        </div>

                        <div class="alert alert-light border py-2 mb-3">
                            <div class="d-flex flex-wrap gap-3 align-items-center">
                                <div><span class="legend-dot dot-blue me-1"></span> Initial</div>
                                <div><span class="legend-dot dot-green me-1"></span> R√©siduel (si contr√¥le effectif)</div>
                                <div class="small-muted">Cliquez une bulle ou un risque dans la liste pour charger la fiche.</div>
                            </div>
                        </div>

                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label required">Code</label>
                                <input class="form-control" id="code" placeholder="R1">
                            </div>
                            <div class="col-8">
                                <label class="form-label required">Domaine</label>
                                <select class="form-select" id="domain">
                                    <option>Classement</option>
                                    <option>Conservation</option>
                                    <option>RGPD</option>
                                    <option>Vie scolaire</option>
                                    <option>RH</option>
                                    <option>Continuit√©</option>
                                    <option>Audit</option>
                                    <option>S√©curit√©</option>
                                    <option>Organisation</option>
                                    <option>Juridique</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label required">Intitul√© du risque</label>
                                <input class="form-control" id="title" placeholder="Non-classement des courriels engageants">
                            </div>

                            <div class="col-12">
                                <label class="form-label">√âtape de proc√©dure concern√©e</label>
                                <select class="form-select" id="step">
                                    <option>R√©ception</option>
                                    <option>N√©cessit√© d‚Äôaction / r√©ponse</option>
                                    <option>Attente</option>
                                    <option>Traitement</option>
                                    <option>Pi√®ces jointes</option>
                                    <option>Qualification administrative</option>
                                    <option selected>Classement J+30</option>
                                    <option>Archivage annuel</option>
                                    <option>Transitoires</option>
                                    <option>Donn√©es sensibles</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label required">Processus porteur du risque</label>
                                <select class="form-select" id="riskProcess">
                                    <option value="">‚Äî S√©lectionner ‚Äî</option>
                                </select>
                                <div class="form-text">Le risque est rattach√© √† un processus ISO (ex : MPM01-001).</div>
                            </div>


                            <div class="col-6">
                                <label class="form-label required">Probabilit√© P (1‚Äì5)</label>
                                <input class="form-control" type="number" min="1" max="5" id="p" value="3">
                            </div>
                            <div class="col-6">
                                <label class="form-label required">Impact I (1‚Äì5)</label>
                                <input class="form-control" type="number" min="1" max="5" id="i" value="3">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Justification (inspection / contexte)</label>
                                <textarea class="form-control" id="justif" rows="3" placeholder="Facteur humain, perte de preuve, non-conformit√© RGPD‚Ä¶"></textarea>
                            </div>

                            <hr class="my-2">

                            <div class="col-12">
                                <h3 class="h6 mb-2">Mesure de contr√¥le (effet attendu)</h3>
                                <div class="small-muted mb-2">ŒîP et ŒîI s‚Äôappliquent uniquement si ‚ÄúMise en ≈ìuvre = Oui‚Äù.</div>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Libell√© de la mesure</label>
                                <input class="form-control" id="controlName" placeholder="Revue mensuelle du classement √† J+30 + rappel automatique">
                            </div>

                            <div class="col-6">
                                <label class="form-label">ŒîP (‚àí4 √† 0)</label>
                                <input class="form-control" type="number" min="-4" max="0" id="dP" value="-1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">ŒîI (‚àí4 √† 0)</label>
                                <input class="form-control" type="number" min="-4" max="0" id="dI" value="0">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Mise en ≈ìuvre</label>
                                <select class="form-select" id="controlImplemented">
                                    <option value="no" selected>Non (pr√©visionnel)</option>
                                    <option value="yes">Oui (effectif)</option>
                                </select>
                            </div>

                            <div class="col-12 d-flex gap-2 mt-2">
                                <button class="btn btn-primary" id="btnSave">Enregistrer</button>
                                <button class="btn btn-outline-secondary" id="btnClear">Vider</button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Matrix + filter list -->
                <div class="col-12 col-xl-8">

                    <div class="card shadow-soft p-3">
                        <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
                            <h2 class="h5 mb-0">Matrice des risques (P √ó I)</h2>
                            <div class="d-flex gap-2 flex-wrap">
                                <span class="pill">Nb risques <span class="mono" id="countRisks">0</span></span>
                                <span class="pill">Critiques <span class="mono" id="countCrit">0</span></span>
                                <span class="pill">√âlev√©s <span class="mono" id="countHigh">0</span></span>
                                <span class="pill">Affich√©s <span class="mono" id="countShown">0</span></span>
                            </div>
                        </div>
                        <div class="row g-2 align-items-end mb-2">
                            <div class="col-md-4">
                                <label class="form-label mb-1">Filtrer par processus</label>
                                <select class="form-select form-select-sm" id="matrixFilterProcess">
                                    <option value="">‚Äî Tous les processus ‚Äî</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label mb-1">Filtrer par proc√©dure</label>
                                <select class="form-select form-select-sm" id="matrixFilterProcedure">
                                    <option value="">‚Äî Toutes les proc√©dures ‚Äî</option>
                                </select>
                            </div>

                            <div class="col-md-4 d-flex gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="btnClearMatrixFilters">
                                    R√©initialiser
                                </button>
                            </div>
                        </div>

                        <div class="matrix-area">
                            <div class="matrix-wrap">
                                <div class="matrix" id="matrix"></div>
                                <div class="small-muted mt-2">
                                    Cliquez une bulle pour charger la fiche. Les risques affich√©s sont ceux coch√©s dans la liste √† droite.
                                </div>
                            </div>

                            <div>
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="fw-semibold">Filtre d‚Äôaffichage</div>
                                    <div class="btn-group btn-group-sm" role="group" aria-label="filter buttons">
                                        <button class="btn btn-outline-secondary" id="btnAll">Tout</button>
                                        <button class="btn btn-outline-secondary" id="btnNone">Aucun</button>
                                    </div>
                                </div>

                                <input class="form-control form-control-sm mb-2" id="filterSearch" placeholder="Rechercher dans la liste‚Ä¶">

                                <div class="risk-list" id="riskList"></div>

                                <div class="small-muted mt-2">
                                    Coche = visible sur matrice. Clic sur le libell√© = ouvrir la fiche √† gauche.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Register -->
                    <div class="card shadow-soft p-3 mt-3">
                        <div class="d-flex flex-wrap gap-2 align-items-center justify-content-between mb-2">
                            <h2 class="h5 mb-0">Registre</h2>
                            <div class="d-flex gap-2 flex-wrap">
                                <input class="form-control" style="max-width:340px;" id="search" placeholder="Rechercher (code, domaine, texte)‚Ä¶">
                                <select class="form-select" style="max-width:220px;" id="filterLevel">
                                    <option value="">Tous niveaux</option>
                                    <option>Critique</option>
                                    <option>√âlev√©</option>
                                    <option>Significatif</option>
                                    <option>Mod√©r√©</option>
                                    <option>Faible</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Domaine</th>
                                        <th>Risque</th>
                                        <th class="nowrap">P√óI</th>
                                        <th>Niveau</th>
                                        <th class="nowrap">Contr√¥le</th>
                                        <th class="nowrap">R√©siduel</th>
                                        <th class="nowrap">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-domains">
            <div class="row g-3">
                <!-- Synth√®se globale -->
                <div class="col-12">
                    <div class="card shadow-soft p-3">
                        <h5 class="mb-2">Synth√®se globale ‚Äì Ma√Ætrise des domaines</h5>
                        <div class="row g-2" id="domainSummaryCards"></div>
                    </div>
                </div>

                <!-- Tableau d√©taill√© -->
                <div class="col-12">
                    <div class="card shadow-soft p-3">
                        <h5 class="mb-2">D√©tail par domaine</h5>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>Domaine</th>
                                        <th>Risques</th>
                                        <th>Crit./√âlev√©s</th>
                                        <th>Ma√Ætris√©s</th>
                                        <th>Taux</th>
                                        <th>Niveau</th>
                                        <th>Processus concern√©s</th>
                                    </tr>
                                </thead>
                                <tbody id="domainTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tab-mp-domains">
            <div class="card shadow-soft p-3">
                <h5 class="mb-2">Vue Macroprocessus √ó Domaines</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle text-center">
                        <thead>
                            <tr id="mpDomainHeader"></tr>
                        </thead>
                        <tbody id="mpDomainBody"></tbody>
                    </table>
                </div>
                <div class="small text-muted mt-2">
                    üü¢ Ma√Ætris√© ¬∑ üü° √Ä renforcer ¬∑ üî¥ Faible
                </div>
            </div>
        </div>
        <footer class="mt-5 text-center small-note">
			<span id="app-version"> Version</span>
        </footer>
    </div>
  <script>
      /**
       * M@TRISK - Pilotage des risques, des processus et de la conformit√©
       *
       * @version 0.0.1
       * @author Yann Bogdanovic
       * @description
       *  - M@TRISK
       * @changelog
       *  v0.0.1
       *    - ajout codebanque.json pour une maj des donn√©es de r√©f√©rence en local
       *    - domiciliation de la banque non bloquante pour le g√©n√©ration du RIB en PDF
       */
      const APP_VERSION = "M@TRISK - v0.0.1";
      window.addEventListener("DOMContentLoaded", () => {
          const el = document.getElementById("app-version");
          if (el) el.textContent = APP_VERSION;
      });

      const STORAGE_KEY = "eple_mail_controleinterne_v2";

      function renderMacroprocesses() {
          const c = $("macroprocessList");
          c.innerHTML = "";

          state.macroprocesses.forEach(mp => {
              c.innerHTML += `
		  <div class="border rounded p-2 mb-2">
			<div class="fw-semibold">${mp.id} ‚Äì ${mp.name}</div>
			<div class="small-muted">
			  Type : ${mp.type} ¬∑ Responsable : ${mp.owner || "‚Äî"}
			</div>
		  </div>`;
          });
      }


      function tagShapePoints(cx, cy, w, h, orientation) {
          // Forme = rectangle + triangle (5 c√¥t√©s)
          // orientation: "down" | "right" | "up"

          const left = cx - w / 2;
          const right = cx + w / 2;
          const top = cy - h / 2;
          const bot = cy + h / 2;

          const tri = Math.min(w, h) * 0.22; // taille de la pointe
          const inset = Math.min(w, h) * 0.10; // l√©ger retrait pour l'esth√©tique

          if (orientation === "down") {
              // Rectangle + triangle bas
              // Rectangle: (left, top) -> (right, top) -> (right, bot - tri) -> (left, bot - tri)
              // Triangle: base sur y = bot - tri, pointe au centre bas
              return [
                  [left, top],
                  [right, top],
                  [right, bot - tri],
                  [cx, bot], // pointe
                  [left, bot - tri]
              ];
          }

          if (orientation === "up") {
              // Rectangle + triangle haut
              return [
                  [left, top + tri],
                  [cx, top], // pointe
                  [right, top + tri],
                  [right, bot],
                  [left, bot]
              ];
          }

          // "right": Rectangle + triangle droite
          return [
              [left, top],
              [right - tri, top],
              [right, cy], // pointe
              [right - tri, bot],
              [left, bot]
          ];
      }

      function ptsToString(pts) {
          return pts.map(p => `${p[0].toFixed(1)},${p[1].toFixed(1)}`).join(" ");
      }

      function renderMacroprocessMap() {
          const svg = $("mpMap");
          if (!svg) return;

          const gP = $("mpPilotage");
          const gM = $("mpMetier");
          const gS = $("mpSupport");
          if (!gP || !gM || !gS) return;

          gP.innerHTML = "";
          gM.innerHTML = "";
          gS.innerHTML = "";

          const all = (state.macroprocesses || []);

          const pilotage = all.filter(x => x.type === "P");
          const metier = all.filter(x => x.type === "M");
          const support = all.filter(x => x.type === "S");

          // Couleurs (famille)
          const COLORS = {
              P: {
                  fill: "#0d6efd",
                  text: "#ffffff"
              },
              M: {
                  fill: "#198754",
                  text: "#ffffff"
              },
              S: {
                  fill: "#fd7e14",
                  text: "#1f2937"
              }
          };

          // Layout (grille simple par zone)
          // Zone Pilotage: y ~ 120 ; M√©tier: y ~ 365 ; Support: y ~ 610
          const layoutZone = (items, zoneY, orientation, group, type) => {
              const colCount = Math.max(1, Math.min(5, items.length || 1));
              const spacingX = 230; // espacement horizontal
              const startX = 260; // laisse de la place aux titres √† gauche
              const maxPerRow = 4; // lignes si beaucoup

              items.forEach((mp, idx) => {
                  const row = Math.floor(idx / maxPerRow);
                  const col = idx % maxPerRow;

                  const cx = startX + col * spacingX;
                  const cy = zoneY + row * 85;

                  const w = 210,
                      h = 90;

                  const poly = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                  poly.setAttribute("points", ptsToString(tagShapePoints(cx, cy, w, h, orientation)));
                  poly.setAttribute("fill", COLORS[type].fill);
                  poly.setAttribute("opacity", "0.92");
                  poly.setAttribute("class", "mp-shape");
                  poly.setAttribute("data-mp-id", mp.id);
                  poly.setAttribute("tabindex", "0");
                  poly.setAttribute("role", "button");

                  // Option: clic => ouvrir fiche macroprocessus
                  poly.addEventListener("click", () => {
                      if (typeof editMacroprocess === "function") editMacroprocess(mp.id);
                  });
                  // Option: clic => ouvrir onglet processus
                  poly.addEventListener("dblclick", (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      openProcessTabForMacroprocess(mp.id);
                  });

                  // Label (2 lignes)
                  const t1 = document.createElementNS("http://www.w3.org/2000/svg", "text");
                  t1.setAttribute("x", cx);
                  t1.setAttribute("y", cy - 6);
                  t1.setAttribute("text-anchor", "middle");
                  t1.setAttribute("font-size", "18");
                  t1.setAttribute("font-weight", "800");
                  t1.setAttribute("fill", COLORS[type].text);
                  t1.setAttribute("class", "mp-label");
                  t1.textContent = mp.id;

                  const t2 = document.createElementNS("http://www.w3.org/2000/svg", "text");
                  t2.setAttribute("x", cx);
                  t2.setAttribute("y", cy + 20);
                  t2.setAttribute("text-anchor", "middle");
                  t2.setAttribute("font-size", "14");
                  t2.setAttribute("font-weight", "600");
                  t2.setAttribute("fill", COLORS[type].text);
                  t2.setAttribute("class", "mp-label");

                  // tronque le nom pour rester propre
                  const name = (mp.name || "").trim();
                  t2.textContent = name.length > 30 ? name.slice(0, 29) + "‚Ä¶" : name;

                  group.appendChild(poly);
                  group.appendChild(t1);
                  group.appendChild(t2);
              });
          };

          layoutZone(pilotage, 130, "down", gP, "P");
          layoutZone(metier, 380, "right", gM, "M");
          layoutZone(support, 625, "up", gS, "S");
      }

      function openProcessTabForMacroprocess(mpId) {
          selectedMacroprocessForProcessTab = mpId;
          openTab("tab-processus");

          // pr√©-s√©lection du select (si pr√©sent) + rendu
          const sel = $("procMpSelect");
          if (sel) sel.value = mpId;

          renderProcessTab();
      }

      function renderProcMpSelect() {
          const sel = $("procMpSelect");
          if (!sel) return;

          const mps = (state.macroprocesses || []).slice().sort((a, b) => a.id.localeCompare(b.id));
          sel.innerHTML = mps.map(mp => `<option value="${escapeHtml(mp.id)}">${escapeHtml(mp.id)} ‚Äî ${escapeHtml(mp.name)}</option>`).join("");

          // valeur par d√©faut
          if (!selectedMacroprocessForProcessTab && mps.length) selectedMacroprocessForProcessTab = mps[0].id;
          if (selectedMacroprocessForProcessTab) sel.value = selectedMacroprocessForProcessTab;

          $("procMpBadge").textContent = selectedMacroprocessForProcessTab || "‚Äî";
      }

      function renderProcessList() {
          const list = $("procList");
          if (!list) return;

          const mpId = $("procMpSelect")?.value || selectedMacroprocessForProcessTab;
          selectedMacroprocessForProcessTab = mpId || selectedMacroprocessForProcessTab;
          $("procMpBadge").textContent = selectedMacroprocessForProcessTab || "‚Äî";

          const q = ($("procSearch")?.value || "").trim().toLowerCase();

          const items = (state.processes || [])
              .filter(p => p.macroprocessId === selectedMacroprocessForProcessTab)
              .filter(p => {
                  const hay = `${p.id} ${p.name}`.toLowerCase();
                  return !q || hay.includes(q);
              })
              .sort((a, b) => a.id.localeCompare(b.id));

          list.innerHTML = "";

          items.forEach(p => {
              const div = document.createElement("div");
              div.className = "risk-item" + ((selectedProcessId === p.id) ? " selected" : "");
              div.dataset.procId = p.id;

              div.innerHTML = `
		  <div class="meta">
			<div class="d-flex align-items-center justify-content-between gap-2">
			  <div class="title"><span class="mono">${escapeHtml(p.id)}</span> ‚Äî ${escapeHtml(p.name)}</div>
			  <span class="badge text-bg-secondary tag">Processus</span>
			</div>
			<div class="sub">${escapeHtml(p.pilot || "‚Äî")} ¬∑ ${escapeHtml(p.purpose || "")}</div>
		  </div>
		`;

              div.addEventListener("click", () => editProcess(p.id));
              div.addEventListener("dblclick", (e) => {
                  e.preventDefault();
                  e.stopPropagation();
                  openProceduresTabForProcess(p.id);
              });

              list.appendChild(div);
          });
      }

      function countRisksForProcess(processId) {
          return (state.risks || []).filter(r => r.processId === processId).length;
      }

      function renderProcessRiskCount(processId) {
          const el = document.getElementById("procRiskCount");
          if (!el) return;
          el.textContent = processId ? String(countRisksForProcess(processId)) : "0";
      }

      function editProcess(id) {
          const p = (state.processes || []).find(x => x.id === id);
          if (!p) return;

          selectedProcessId = id;
          $("procCodeBadge").textContent = id;

          // Charger champs
          $("procId").value = p.id || "";
          $("procName").value = p.name || "";
          $("procPilot").value = p.pilot || "";
          $("procPurpose").value = p.purpose || "";
          $("procScope").value = p.scope || "";
          $("procInputs").value = p.inputs || "";
          $("procOutputs").value = p.outputs || "";
          $("procResources").value = p.resources || "";
          $("procInteractions").value = p.interactions || "";
          $("procKpi").value = p.kpi || "";
          $("procRisks").value = p.risks || "";
          $("procDocs").value = p.docs || "";

          renderProcessList();
          renderProcessRisks(id);
          renderProcessRiskCount(id);
      }

      function clearProcessForm() {
          selectedProcessId = null;
          $("procCodeBadge").textContent = "‚Äî";
          ["procId", "procName", "procPilot", "procPurpose", "procScope", "procInputs", "procOutputs", "procResources", "procInteractions", "procKpi", "procRisks", "procDocs"]
          .forEach(id => {
              const el = $(id);
              if (el) el.value = "";
          });
          renderProcessList();
          renderProcessRiskCount(id);

          $("processRiskTable").innerHTML = "";
      }

      function newProcess() {
          // propose un code auto MPPxx-001
          const mpId = $("procMpSelect")?.value || selectedMacroprocessForProcessTab || "";
          const prefix = `${mpId}-`;
          const nums = (state.processes || [])
              .filter(p => p.id?.startsWith(prefix))
              .map(p => parseInt((p.id.split("-")[1] || "0"), 10))
              .filter(n => !Number.isNaN(n));
          const next = String((nums.length ? Math.max(...nums) + 1 : 1)).padStart(3, "0");

          clearProcessForm();
          $("procId").value = `${mpId}-${next}`;
          $("procName").focus();
      }

      function upsertProcessFromForm() {
          const mpId = $("procMpSelect")?.value || selectedMacroprocessForProcessTab;
          if (!mpId) {
              alert("S√©lectionnez un macroprocessus.");
              return;
          }

          const id = ($("procId").value || "").trim().toUpperCase();
          const name = ($("procName").value || "").trim();
          if (!id || !name) {
              alert("Code et nom du processus requis.");
              return;
          }

          const obj = {
              id,
              macroprocessId: mpId,
              name,
              pilot: ($("procPilot").value || "").trim(),
              purpose: ($("procPurpose").value || "").trim(),
              scope: ($("procScope").value || "").trim(),
              inputs: ($("procInputs").value || "").trim(),
              outputs: ($("procOutputs").value || "").trim(),
              resources: ($("procResources").value || "").trim(),
              interactions: ($("procInteractions").value || "").trim(),
              kpi: ($("procKpi").value || "").trim(),
              risks: ($("procRisks").value || "").trim(),
              docs: ($("procDocs").value || "").trim()
          };

          const idx = state.processes.findIndex(p => p.id === id);
          if (idx >= 0) state.processes[idx] = obj;
          else state.processes.push(obj);

          saveState();
          selectedProcessId = id;
          $("procCodeBadge").textContent = id;

          renderProcessTab();
      }

      function deleteProcess() {
          if (!selectedProcessId) return;
          if (!confirm(`Supprimer ${selectedProcessId} ?`)) return;
          state.processes = (state.processes || []).filter(p => p.id !== selectedProcessId);
          saveState();
          clearProcessForm();
          renderProcessTab();
      }

      function renderProcessTab() {
          renderProcMpSelect();
          renderProcessList();

          // si un processus est s√©lectionn√© mais ne correspond plus au MP, on nettoie
          if (selectedProcessId) {
              const p = (state.processes || []).find(x => x.id === selectedProcessId);
              if (!p || p.macroprocessId !== selectedMacroprocessForProcessTab) clearProcessForm();
          }
      }

      function openProceduresTabForProcess(processId) {
          // m√©morise le filtre de l'onglet proc√©dures
          selectedProcessForProceduresTab = processId;

          // ouvre l'onglet
          openTab("tab-procedures");

          // positionne le select (si d√©j√† rendu)
          const sel = document.getElementById("proc2ProcessSelect");
          if (sel) sel.value = processId;

          // rendu onglet proc√©dures
          renderProceduresTab?.();

          // Si une seule proc√©dure existe pour ce processus => l'ouvrir directement
          const procs = (state.procedures || []).filter(p => p.processId === processId);
          if (procs.length === 1) {
              editProcedure(procs[0].id);
          } else {
              // sinon on laisse la liste filtr√©e et la fiche vide
              clearProcedureForm?.();
          }
      }

      function renderProcessRisks(processId) {
          const c = $("processRiskTable");
          if (!c || !processId) return;

          const risks = (state.risks || [])
              .map(computeRisk)
              .filter(r => r.processId === processId);

          if (risks.length === 0) {
              c.innerHTML = `<div class="text-muted">Aucun risque rattach√© √† ce processus.</div>`;
              return;
          }

          c.innerHTML = `
		<div class="table-responsive">
		  <table class="table table-sm align-middle">
			<thead>
			  <tr>
				<th>Risque</th>
				<th>Score initial</th>
				<th>Niveau</th>
				<th>Mesure de contr√¥le</th>
				<th>Score r√©siduel</th>
				<th>Statut</th>
			  </tr>
			</thead>
			<tbody>
			  ${risks.map(r => `
				<tr>
				  <td>
					<div class="fw-semibold">${r.id} ‚Äì ${r.title}</div>
				  </td>
				  <td class="mono">${r.score}</td>
				  <td>${r.level}</td>
				  <td>${r.control?.name || "‚Äî"}</td>
				  <td class="mono">
					${r.control?.implemented ? r.scoreRes : "‚Äî"}
				  </td>
				  <td>
					${riskStatusBadge(r)}
				  </td>
				</tr>
			  `).join("")}
			</tbody>
		  </table>
		</div>
	  `;
      }

      function riskStatusBadge(r) {
          if (!r.control || !r.control.name)
              return `<span class="badge text-bg-secondary">Non ma√Ætris√©</span>`;

          if (!r.control.implemented)
              return `<span class="badge text-bg-warning">Contr√¥le pr√©vu</span>`;

          if (r.scoreRes <= 7)
              return `<span class="badge text-bg-success">Ma√Ætris√©</span>`;

          return `<span class="badge text-bg-danger">√Ä renforcer</span>`;
      }


      // ====== Proc√©dures Tab State ======


      // Remplit le select Processus (onglet Proc√©dures)
      function renderProc2ProcessSelect() {
          const sel = $("proc2ProcessSelect");
          if (!sel) return;

          const procs = (state.processes || []).slice().sort((a, b) => a.id.localeCompare(b.id));
          sel.innerHTML = procs.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.id)} ‚Äî ${escapeHtml(p.name)}</option>`).join("");

          if (!selectedProcessForProceduresTab && procs.length) selectedProcessForProceduresTab = procs[0].id;
          if (selectedProcessForProceduresTab) sel.value = selectedProcessForProceduresTab;

          $("proc2ProcessBadge").textContent = selectedProcessForProceduresTab || "‚Äî";
      }

      // Liste des proc√©dures du processus s√©lectionn√©
      function renderProcedureList() {
          const list = $("proc2List");
          if (!list) return;

          const pid = $("proc2ProcessSelect")?.value || selectedProcessForProceduresTab;
          selectedProcessForProceduresTab = pid;
          $("proc2ProcessBadge").textContent = pid || "‚Äî";

          const q = ($("proc2Search")?.value || "").trim().toLowerCase();

          const items = (state.procedures || [])
              .filter(pr => pr.processId === pid)
              .filter(pr => {
                  const hay = `${pr.id} ${pr.name} ${pr.version || ""}`.toLowerCase();
                  return !q || hay.includes(q);
              })
              .sort((a, b) => (a.id || "").localeCompare(b.id || ""));

          list.innerHTML = "";
          items.forEach(pr => {
              const div = document.createElement("div");
              div.className = "risk-item" + ((selectedProcedureId === pr.id) ? " selected" : "");
              div.dataset.procedureId = pr.id;
              div.innerHTML = `
		  <div class="meta">
			<div class="d-flex align-items-center justify-content-between gap-2">
			  <div class="title"><span class="mono">${escapeHtml(pr.id)}</span> ‚Äî ${escapeHtml(pr.name)}</div>
			  <span class="badge text-bg-secondary tag">${escapeHtml(pr.version || "‚Äî")}</span>
			</div>
			<div class="sub">${escapeHtml(pid)} ¬∑ ${escapeHtml((pr.steps?.length || 0) + " √©tape(s)")}</div>
		  </div>
		`;
              div.addEventListener("click", () => editProcedure(pr.id));
              list.appendChild(div);
          });
      }

      // Charge une proc√©dure dans la fiche + rend √©tapes + logigramme
      function editProcedure(id) {
          const pr = (state.procedures || []).find(x => x.id === id);
          if (!pr) return;

          selectedProcedureId = id;
          $("proc2Badge").textContent = id;

          $("proc2Id").value = pr.id || "";
          $("proc2Name").value = pr.name || "";
          $("proc2Version").value = pr.version || "";

          renderStepsEditor(pr);
          renderFlow(pr);

          renderProcedureList();
      }

      // Vide la fiche
      function clearProcedureForm() {
          selectedProcedureId = null;
          lastContext = null;
          renderRiskReturnButton();
          $("proc2Badge").textContent = "‚Äî";
          ["proc2Id", "proc2Name", "proc2Version"].forEach(id => $(id).value = "");
          $("proc2StepsEditor").innerHTML = "";
          $("proc2FlowBody").innerHTML = "";
          renderProcedureList();
      }

      // Nouvelle proc√©dure
      function newProcedure() {
          clearProcedureForm();
          const pid = selectedProcessForProceduresTab || $("proc2ProcessSelect")?.value || "";
          $("proc2Id").value = `PROC-${pid.replaceAll("-","")}-001`.toUpperCase();
          $("proc2Name").focus();
      }

      // Enregistrer proc√©dure (create/update)
      function upsertProcedureFromForm() {
          const pid = $("proc2ProcessSelect")?.value || selectedProcessForProceduresTab;
          if (!pid) {
              alert("S√©lectionnez un processus.");
              return;
          }

          const id = ($("proc2Id").value || "").trim().toUpperCase();
          const name = ($("proc2Name").value || "").trim();
          if (!id || !name) {
              alert("ID et Nom requis.");
              return;
          }

          // R√©cup√®re √©tapes depuis l‚Äô√©diteur
          const steps = readStepsEditor();

          const pr = {
              id,
              processId: pid,
              name,
              version: ($("proc2Version").value || "").trim(),
              steps
          };

          const idx = state.procedures.findIndex(x => x.id === id);
          if (idx >= 0) state.procedures[idx] = pr;
          else state.procedures.push(pr);

          saveState();
          selectedProcedureId = id;
          $("proc2Badge").textContent = id;

          renderProcedureList();
          renderStepsEditor(pr);
          renderFlow(pr);
      }

      // Supprimer
      function deleteProcedure() {
          if (!selectedProcedureId) return;
          if (!confirm(`Supprimer ${selectedProcedureId} ?`)) return;
          state.procedures = (state.procedures || []).filter(p => p.id !== selectedProcedureId);
          saveState();
          clearProcedureForm();
      }

      // ====== Steps editor (simple) ======
      function renderStepsEditor(pr) {
          const c = $("proc2StepsEditor");
          if (!c) return;
          const steps = pr.steps || [];

          c.innerHTML = `
		<div class="d-flex align-items-center justify-content-between mb-2">
		  <div class="fw-semibold">√âtapes (√©dition)</div>
		  <div class="small text-muted">Renseigner Qui / Fait quoi / Comment + risques (R1,R2‚Ä¶)</div>
		</div>
		${steps.map((s, idx) => `
		  <div class="step-card mb-2" data-step-index="${idx}">
			<div class="row g-2">
			  <div class="col-md-3">
				<label class="form-label mb-1">Qui ?</label>
				<input class="form-control form-control-sm step-who" value="${escapeHtml(s.who || "")}">
			  </div>
			  <div class="col-md-5">
				<label class="form-label mb-1">Fait quoi ?</label>
				<input class="form-control form-control-sm step-what" value="${escapeHtml(s.what || "")}">
			  </div>
			  <div class="col-md-4">
				<label class="form-label mb-1">Comment ?</label>
				<input class="form-control form-control-sm step-how" value="${escapeHtml(s.how || "")}">
			  </div>

			  <div class="col-12">
				<label class="form-label mb-1">Risques (IDs s√©par√©s par virgules)</label>
				<input class="form-control form-control-sm step-risks" value="${escapeHtml((s.riskIds || []).join(","))}" placeholder="R1,R7,R9">
			  </div>

			  <div class="col-12 step-actions d-flex gap-2">
				<button type="button" class="btn btn-sm btn-outline-secondary" data-move-up="${idx}">‚Üë</button>
				<button type="button" class="btn btn-sm btn-outline-secondary" data-move-down="${idx}">‚Üì</button>
				<button type="button" class="btn btn-sm btn-outline-danger ms-auto" data-delete-step="${idx}">Suppr.</button>
			  </div>
			</div>
		  </div>
		`).join("")}
	  `;

          // Bind buttons
          c.querySelectorAll("[data-delete-step]").forEach(btn => {
              btn.addEventListener("click", () => {
                  const i = parseInt(btn.dataset.deleteStep, 10);
                  const steps = readStepsEditor();
                  steps.splice(i, 1);
                  pr.steps = steps;
                  renderStepsEditor(pr);
                  renderFlow(pr);
              });
          });

          c.querySelectorAll("[data-move-up]").forEach(btn => {
              btn.addEventListener("click", () => {
                  const i = parseInt(btn.dataset.moveUp, 10);
                  const steps = readStepsEditor();
                  if (i <= 0) return;
                  [steps[i - 1], steps[i]] = [steps[i], steps[i - 1]];
                  pr.steps = steps;
                  renderStepsEditor(pr);
                  renderFlow(pr);
              });
          });

          c.querySelectorAll("[data-move-down]").forEach(btn => {
              btn.addEventListener("click", () => {
                  const i = parseInt(btn.dataset.moveDown, 10);
                  const steps = readStepsEditor();
                  if (i >= steps.length - 1) return;
                  [steps[i], steps[i + 1]] = [steps[i + 1], steps[i]];
                  pr.steps = steps;
                  renderStepsEditor(pr);
                  renderFlow(pr);
              });
          });
      }

      function readStepsEditor() {
          const c = $("proc2StepsEditor");
          if (!c) return [];
          const cards = Array.from(c.querySelectorAll(".step-card"));
          return cards.map(card => {
              const who = card.querySelector(".step-who")?.value || "";
              const what = card.querySelector(".step-what")?.value || "";
              const how = card.querySelector(".step-how")?.value || "";
              const risksRaw = card.querySelector(".step-risks")?.value || "";
              const riskIds = risksRaw.split(",").map(x => x.trim().toUpperCase()).filter(Boolean);
              return {
                  who,
                  what,
                  how,
                  riskIds
              };
          });
      }

      // Ajouter une √©tape
      function addStep() {
          const id = ($("proc2Id").value || "").trim().toUpperCase();
          if (!id) {
              alert("Cr√©ez/enregistrez d‚Äôabord une proc√©dure (ID).");
              return;
          }

          const pr = (state.procedures || []).find(x => x.id === id) || {
              id,
              processId: selectedProcessForProceduresTab,
              name: $("proc2Name").value || "",
              version: $("proc2Version").value || "",
              steps: []
          };

          pr.steps = pr.steps || [];
          pr.steps.push({
              who: "",
              what: "",
              how: "",
              riskIds: []
          });

          renderStepsEditor(pr);
          renderFlow(pr);
      }

      // ====== Logigramme 3 colonnes ======
      function renderFlow(pr) {
          const tb = $("proc2FlowBody");
          if (!tb) return;

          const steps = pr.steps || [];
          tb.innerHTML = "";

          steps.forEach((s, idx) => {
              const tr = document.createElement("tr");

              const isLast = idx === steps.length - 1;

              const risks = (s.riskIds || []).map(rid => {
                  return `<span class="badge text-bg-warning me-1 risk-badge" data-risk="${escapeHtml(rid)}">${escapeHtml(rid)}</span>`;
              }).join("");

              tr.innerHTML = `
		  <td class="flow-step ${isLast ? "flow-last" : ""}">
			<div class="step-card">
			  ${escapeHtml(s.who || "‚Äî")}
			</div>
		  </td>
		  <td class="flow-step ${isLast ? "flow-last" : ""}">
			<div class="step-card">
			  <div class="fw-semibold">${escapeHtml(s.what || "‚Äî")}</div>
			  <div class="mt-1">${risks ? `<div class="small text-muted mb-1">Risques :</div>${risks}` : `<span class="text-muted small">‚Äî</span>`}</div>
			</div>
		  </td>
		  <td class="flow-step ${isLast ? "flow-last" : ""}">
			<div class="step-card">
			  ${escapeHtml(s.how || "‚Äî")}
			</div>
		  </td>
		`;

              tb.appendChild(tr);
          });

          // Bind clic risque => ouvrir fiche risque
          tb.querySelectorAll("[data-risk]").forEach(b => {
              const riskId = b.getAttribute("data-risk");

              // clic simple : √©dition locale
              b.addEventListener("click", (e) => {
                  e.stopPropagation();
                  if (typeof editRisk === "function") editRisk(riskId);
              });

              // double clic : bascule onglet Risques + m√©morise contexte
              b.addEventListener("dblclick", (e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  lastContext = {
                      fromTab: "tab-procedures",
                      procedureId: selectedProcedureId,
                      processId: selectedProcessForProceduresTab
                  };

                  openTab("tab-risques");

                  setTimeout(() => {
                      if (typeof editRisk === "function") editRisk(riskId);
                      renderRiskReturnButton();
                  }, 50);
              });
          });


      }

      // Rendu global de l‚Äôonglet Proc√©dures
      function renderProceduresTab() {
          renderProc2ProcessSelect();
          renderProcedureList();
      }




      // Matrice
      const LEVELS = [{
              min: 20,
              max: 25,
              label: "Critique"
          },
          {
              min: 15,
              max: 19,
              label: "√âlev√©"
          },
          {
              min: 8,
              max: 14,
              label: "Significatif"
          },
          {
              min: 4,
              max: 7,
              label: "Mod√©r√©"
          },
          {
              min: 1,
              max: 3,
              label: "Faible"
          }
      ];

      const IMPACT_LABELS = ["Tr√®s faible", "Faible", "Moyenne", "√âlev√©e", "Tr√®s √©lev√©e"]; // I=1..5
      const PROBA_LABELS = ["Tr√®s faible", "Faible", "Moyenne", "√âlev√©e", "Tr√®s √©lev√©e"]; // P=1..5

      const $ = (id) => document.getElementById(id);

      // UI state
      let lastContext = null;
      let selectedRiskId = null; // currently opened in form

      function clampInt(v, min, max) {
          let n = parseInt(v, 10);
          if (Number.isNaN(n)) n = min;
          return Math.max(min, Math.min(max, n));
      }

      function levelFromScore(score) {
          const hit = LEVELS.find(l => score >= l.min && score <= l.max);
          return hit ? hit.label : "‚Äî";
      }

      function heatClass(score) {
          if (score >= 20) return "heat-r";
          if (score >= 15) return "heat-o";
          if (score >= 8) return "heat-y";
          return "heat-g";
      }

      function escapeHtml(s) {
          return (s ?? "").toString()
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");
      }

      function seedRisks() {
          return [{
                  id: "R1",
                  domain: "Classement",
                  title: "Non-classement des courriels engageants",
                  step: "Classement J+30",
                  p: 5,
                  i: 4,
                  processId: "MPM01-001",
                  justification: "Risque fr√©quent (facteur humain), perte de preuve administrative",
                  control: {
                      name: "Revue mensuelle + rappel J+21",
                      dP: -1,
                      dI: 0,
                      implemented: true
                  },
                  visible: true
              },
              {
                  id: "R2",
                  domain: "Conservation",
                  title: "Suppression pr√©matur√©e d‚Äôun courriel probant",
                  step: "Transitoires",
                  p: 3,
                  i: 5,
                  processId: "MPM01-001",
                  justification: "Suppression possible, impact juridique majeur",
                  control: {
                      name: "R√®gle de conservation + check trimestriel",
                      dP: -1,
                      dI: 0,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R3",
                  domain: "RGPD",
                  title: "Conservation excessive de donn√©es personnelles",
                  step: "Archivage annuel",
                  p: 4,
                  i: 4,
                  processId: "MPM01-001",
                  justification: "Pratique courante, non-conformit√© RGPD",
                  control: {
                      name: "Purge annuelle + registre dur√©es",
                      dP: -1,
                      dI: -1,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R4",
                  domain: "Vie scolaire",
                  title: "Divulgation de donn√©es sensibles √©l√®ves",
                  step: "Donn√©es sensibles",
                  p: 3,
                  i: 5,
                  processId: "MPM01-001",
                  justification: "Donn√©es mineurs, impact RGPD maximal",
                  control: {
                      name: "Acc√®s restreint + sensibilisation + chiffrement PJ",
                      dP: -1,
                      dI: -1,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R5",
                  domain: "RH",
                  title: "Acc√®s non autoris√© √† des donn√©es RH",
                  step: "Donn√©es sensibles",
                  p: 3,
                  i: 5,
                  processId: "MPM01-001",
                  justification: "Donn√©es sensibles agents, responsabilit√© CE",
                  control: {
                      name: "Dossiers RH s√©par√©s + droits + revue acc√®s",
                      dP: -1,
                      dI: -1,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R6",
                  domain: "Continuit√©",
                  title: "Perte d‚Äôinformations lors d‚Äôun changement d‚Äôagent",
                  step: "Traitement",
                  p: 3,
                  i: 4,
                  processId: "MPM01-001",
                  justification: "D√©pendance √† l‚Äôagent, d√©sorganisation",
                  control: {
                      name: "Bo√Æte fonctionnelle + passation + proc√©dure",
                      dP: -1,
                      dI: 0,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R7",
                  domain: "Audit",
                  title: "Impossibilit√© de produire une preuve",
                  step: "Qualification administrative",
                  p: 2,
                  i: 5,
                  processId: "MPM01-001",
                  justification: "Faible fr√©quence, impact fort en contr√¥le",
                  control: {
                      name: "Indexation + stockage PJ en espace partag√©",
                      dP: 0,
                      dI: -1,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R8",
                  domain: "S√©curit√©",
                  title: "Synchronisation non ma√Ætris√©e (cloud, perso)",
                  step: "Donn√©es sensibles",
                  p: 2,
                  i: 5,
                  processId: "MPM01-001",
                  justification: "Pratique marginale mais risque RGPD √©lev√©",
                  control: {
                      name: "Blocage sync perso + charte + contr√¥le poste",
                      dP: -1,
                      dI: -1,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R9",
                  domain: "Organisation",
                  title: "Classement h√©t√©rog√®ne selon les agents",
                  step: "Classement J+30",
                  p: 4,
                  i: 3,
                  processId: "MPM01-001",
                  justification: "Pratique courante, impact organisationnel",
                  control: {
                      name: "Plan de classement unique + audit mensuel",
                      dP: -1,
                      dI: 0,
                      implemented: false
                  },
                  visible: true
              },
              {
                  id: "R10",
                  domain: "Juridique",
                  title: "Conservation d‚Äôemails informels sans valeur",
                  step: "Archivage annuel",
                  p: 5,
                  i: 2,
                  processId: "MPM01-001",
                  justification: "Tr√®s fr√©quent, impact limit√© mais r√©el",
                  control: {
                      name: "R√®gles tri + mod√®le de r√©daction",
                      dP: -1,
                      dI: 0,
                      implemented: false
                  },
                  visible: true
              },
          ];
      }

      function renderRiskProcessSelect(selectedValue = "") {
          const sel = $("riskProcess");
          if (!sel) return;

          const procs = (state.processes || [])
              .slice()
              .sort((a, b) => a.id.localeCompare(b.id));

          sel.innerHTML =
              `<option value="">‚Äî S√©lectionner ‚Äî</option>` +
              procs.map(p => {
                  const label = `${p.id} ‚Äî ${p.name}`;
                  return `<option value="${escapeHtml(p.id)}">${escapeHtml(label)}</option>`;
              }).join("");

          sel.value = selectedValue || "";
      }

      function renderRiskReturnButton() {
          const btn = document.getElementById("btnBackToProcedure");
          if (!btn) return;

          if (lastContext && lastContext.fromTab === "tab-procedures") {
              btn.classList.remove("d-none");
          } else {
              btn.classList.add("d-none");
          }
      }


      function computeRisk(r) {
          const p = clampInt(r.p, 1, 5);
          const i = clampInt(r.i, 1, 5);
          const score = p * i;
          const level = levelFromScore(score);

          let pRes = p,
              iRes = i,
              scoreRes = score,
              levelRes = level;
          const ctrl = r.control || null;

          if (ctrl && ctrl.implemented) {
              const dP = clampInt(ctrl.dP ?? 0, -4, 0);
              const dI = clampInt(ctrl.dI ?? 0, -4, 0);
              pRes = clampInt(p + dP, 1, 5);
              iRes = clampInt(i + dI, 1, 5);
              scoreRes = pRes * iRes;
              levelRes = levelFromScore(scoreRes);
          }

          return {
              ...r,
              p,
              i,
              score,
              level,
              pRes,
              iRes,
              scoreRes,
              levelRes
          };
      }

      function sortRisks() {
          state.risks = state.risks
              .map(computeRisk)
              .sort((a, b) => (b.score - a.score) || a.id.localeCompare(b.id));
      }

      function loadState() {
          try {
              const raw = localStorage.getItem(STORAGE_KEY);
              if (!raw) return {
                  risks: seedRisks()
              };
              const parsed = JSON.parse(raw);
              if (!parsed || !Array.isArray(parsed.risks)) return {
                  risks: seedRisks()
              };

              // Backward compat: ensure visible flag exists
              parsed.risks = parsed.risks.map(r => ({
                  visible: true,
                  ...r
              }));
              return parsed;
          } catch (e) {
              return {
                  risks: seedRisks()
              };
          }
      }

      function saveState() {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state, null, 2));
      }

      function recalcForm() {
          const p = clampInt($("p").value, 1, 5);
          const i = clampInt($("i").value, 1, 5);
          $("p").value = p;
          $("i").value = i;
          const score = p * i;
          $("scoreNow").textContent = score;
          $("levelNow").textContent = levelFromScore(score);
      }

      function clearForm() {
          selectedRiskId = null;
          $("code").value = "";
          $("domain").value = "Classement";
          $("title").value = "";
          $("step").value = "Classement J+30";
          $("p").value = 3;
          $("i").value = 3;
          $("justif").value = "";
          $("controlName").value = "";
          $("dP").value = -1;
          $("dI").value = 0;
          $("controlImplemented").value = "no";
          recalcForm();
          highlightSelectedInList();
          renderRiskProcessSelect("");
          renderRiskReturnButton();
      }

      function upsertRiskFromForm() {
          const id = ($("code").value || "").trim().toUpperCase();
          processId: ($("riskProcess")?.value || null);

          if (!/^R\d+$/i.test(id)) {
              alert("Code requis au format R1, R2, ‚Ä¶");
              return;
          }

          // Preserve existing visibility when editing
          const existing = state.risks.find(x => x.id === id);

          const r = {
              id,
              domain: $("domain").value,
              title: ($("title").value || "").trim() || "(Sans titre)",
              step: $("step").value,
              p: clampInt($("p").value, 1, 5),
              i: clampInt($("i").value, 1, 5),
              processId: ($("riskProcess")?.value || "").trim(),
              justification: ($("justif").value || "").trim(),
              control: {
                  name: ($("controlName").value || "").trim(),
                  dP: clampInt($("dP").value, -4, 0),
                  dI: clampInt($("dI").value, -4, 0),
                  implemented: $("controlImplemented").value === "yes"
              },
              visible: existing ? !!existing.visible : true
          };

          const idx = state.risks.findIndex(x => x.id === id);
          if (idx >= 0) state.risks[idx] = r;
          else state.risks.push(r);

          sortRisks();
          saveState();
          selectedRiskId = id;
          renderAll();
      }

      function editRisk(id) {
          const r0 = state.risks.find(x => x.id === id);
          if (!r0) return;
          const r = computeRisk(r0);

          selectedRiskId = r.id;

          $("code").value = r.id;
          $("domain").value = r.domain;
          $("title").value = r.title;
          $("step").value = r.step || "Classement J+30";
          $("p").value = r.p;
          $("i").value = r.i;
          $("justif").value = r.justification || "";

          $("controlName").value = r.control?.name || "";
          $("dP").value = r.control?.dP ?? -1;
          $("dI").value = r.control?.dI ?? 0;
          $("controlImplemented").value = (r.control?.implemented ? "yes" : "no");

          $("riskProcess").value = r.processId || "";

          renderRiskProcessSelect(r.processId || "");
          renderRiskReturnButton();
          recalcForm();
          highlightSelectedInList();
          window.scrollTo({
              top: 0,
              behavior: "smooth"
          });
      }

      function deleteRisk(id) {
          if (!confirm(`Supprimer ${id} ?`)) return;
          state.risks = state.risks.filter(r => r.id !== id);
          if (selectedRiskId === id) selectedRiskId = null;
          sortRisks();
          saveState();
          renderAll();
          clearForm();
      }

      function openRisksTab() {
          openTab("tab-risques"); // coh√©rent avec data-bs-target="#tab-risques"
      }


      // Matrix -------------------------------------------------------
      function cellKey(p, i) {
          return `p${p}_i${i}`;
      }

      function buildMatrixSkeleton() {
          const m = $("matrix");
          m.innerHTML = "";

          const tl = document.createElement("div");
          tl.className = "m-head";
          tl.textContent = "";
          m.appendChild(tl);

          for (let i = 1; i <= 5; i++) {
              const h = document.createElement("div");
              h.className = "m-head";
              h.textContent = IMPACT_LABELS[i - 1];
              m.appendChild(h);
          }

          for (let p = 5; p >= 1; p--) {
              const side = document.createElement("div");
              side.className = "m-side";
              side.innerHTML = `<div><div class="fw-semibold">${PROBA_LABELS[p-1]}</div><div class="small-muted">P=${p}</div></div>`;
              m.appendChild(side);

              for (let i = 1; i <= 5; i++) {
                  const score = p * i;
                  const c = document.createElement("div");
                  c.className = `cell ${heatClass(score)}`;
                  c.dataset.key = cellKey(p, i);
                  c.innerHTML = `<div class="score">${score}</div>`;
                  m.appendChild(c);
              }
          }
      }

      function clearMatrixMarkers() {
          document.querySelectorAll(".cell .marker").forEach(el => el.remove());
      }

      function placeMarker(cell, kind, riskId, tooltip, same = false) {
          const d = document.createElement("div");
          d.className = `marker ${kind}` + (same ? " same" : "");
          d.title = tooltip;
          d.textContent = riskId;
          d.dataset.riskId = riskId;

          // Click bubble => open risk in left form
          d.addEventListener("click", (ev) => {
              ev.stopPropagation();
              editRisk(riskId);
          });

          cell.appendChild(d);
      }

      function renderMatrix() {
          buildMatrixSkeleton();
          clearMatrixMarkers();

          const computed = state.risks.map(computeRisk);

          const shown = computed.filter(r => r.visible !== false);

          // === FILTRES PROCESSUS / PROCEDURE ===
          const fp = document.getElementById("matrixFilterProcess")?.value || "";
          const fpr = document.getElementById("matrixFilterProcedure")?.value || "";

          // Filtre par processus
          if (fp) {
              shown = shown.filter(r => r.processId === fp);
          }

          // Filtre par proc√©dure
          if (fpr) {
              const allowedRiskIds = new Set(getRiskIdsForProcedure(fpr));
              shown = shown.filter(r => allowedRiskIds.has(r.id));
          }

          $("countShown").textContent = shown.length;

          shown.forEach(r => {
              const cellInh = document.querySelector(`.cell[data-key="${cellKey(r.p, r.i)}"]`);
              if (!cellInh) return;

              const showResidual = (r.control && r.control.implemented);

              const tooltipBase = `${r.id} ‚Äì ${r.title}\nInitial: P=${r.p} I=${r.i} Score=${r.score} (${r.level})`;

              if (!showResidual) {
                  placeMarker(cellInh, "inherent", r.id, tooltipBase + `\nR√©siduel: ‚Äî (contr√¥le non effectif)`, true);
                  return;
              }

              const cellRes = document.querySelector(`.cell[data-key="${cellKey(r.pRes, r.iRes)}"]`);
              if (!cellRes) {
                  placeMarker(cellInh, "inherent", r.id, tooltipBase, true);
                  return;
              }

              const sameCell = (r.p === r.pRes) && (r.i === r.iRes);
              if (sameCell) {
                  placeMarker(cellInh, "inherent", r.id, tooltipBase + `\nR√©siduel: inchang√©`, true);
              } else {
                  placeMarker(cellInh, "inherent", r.id, tooltipBase + `\nR√©siduel: P=${r.pRes} I=${r.iRes} Score=${r.scoreRes} (${r.levelRes})`, false);
                  placeMarker(cellRes, "residual", r.id, tooltipBase + `\nR√©siduel: P=${r.pRes} I=${r.iRes} Score=${r.scoreRes} (${r.levelRes})`, false);
              }
          });
      }

      function renderMatrixProcessFilter() {
          const sel = document.getElementById("matrixFilterProcess");
          if (!sel) return;

          const procs = (state.processes || [])
              .slice()
              .sort((a, b) => a.id.localeCompare(b.id));

          sel.innerHTML =
              `<option value="">‚Äî Tous les processus ‚Äî</option>` +
              procs.map(p =>
                  `<option value="${p.id}">${p.id} ‚Äî ${p.name}</option>`
              ).join("");
      }

      function renderMatrixProcedureFilter() {
          const sel = document.getElementById("matrixFilterProcedure");
          if (!sel) return;

          const procs = (state.procedures || [])
              .slice()
              .sort((a, b) => a.id.localeCompare(b.id));

          sel.innerHTML =
              `<option value="">‚Äî Toutes les proc√©dures ‚Äî</option>` +
              procs.map(p =>
                  `<option value="${p.id}">${p.id} ‚Äî ${p.name}</option>`
              ).join("");
      }

      function getRiskIdsForProcedure(procedureId) {
          const pr = (state.procedures || []).find(p => p.id === procedureId);
          if (!pr || !pr.steps) return [];

          const ids = new Set();
          pr.steps.forEach(s => {
              (s.riskIds || []).forEach(rid => ids.add(rid));
          });
          return Array.from(ids);
      }


      let selectedMacroprocessId = null;

      function mpTypeLabel(t) {
          return t === "P" ? "Pilotage" : (t === "M" ? "M√©tier" : (t === "S" ? "Support" : "‚Äî"));
      }

      function editMacroprocess(id) {
          const mp = (state.macroprocesses || []).find(x => x.id === id);
          if (!mp) return;

          selectedMacroprocessId = id;

          // Remplir le formulaire √† gauche
          $("mpType").value = mp.type || "P";
          $("mpCode").value = mp.id || "";
          $("mpName").value = mp.name || "";
          $("mpOwner").value = mp.owner || "";
          const obj = $("mpObjectives");
          if (obj) obj.value = mp.objectives || "";

          highlightSelectedMPRow();
          // Option : remonter en haut de page (comme risques)
          window.scrollTo({
              top: 0,
              behavior: "smooth"
          });
      }

      function clearMPForm() {
          selectedMacroprocessId = null;
          $("mpType").value = "P";
          $("mpCode").value = "";
          $("mpName").value = "";
          $("mpOwner").value = "";
          const obj = $("mpObjectives");
          if (obj) obj.value = "";
          highlightSelectedMPRow();
      }

      function upsertMacroprocessFromForm() {
          const id = ($("mpCode").value || "").trim().toUpperCase();
          const type = $("mpType").value;
          const name = ($("mpName").value || "").trim();
          const owner = ($("mpOwner").value || "").trim();
          const objectives = ($("mpObjectives")?.value || "").trim();

          if (!id || !/^MP[PM S]\d{2}$/i.test(id.replace(" ", ""))) {
              // tol√©rance : vous utilisez MPP01 / MPM01 / MPS01
              // Donc pattern accept√© : MP(P|M|S)\d{2}
              // Si vous pr√©f√©rez strictement MPPxx etc, dites-moi, je verrouille.
              // On fait ici permissif.
          }
          if (!id.startsWith("MP")) {
              alert("Code macroprocessus attendu (ex: MPP01, MPM01, MPS01).");
              return;
          }
          if (!name) {
              alert("Nom requis.");
              return;
          }

          if (!state.macroprocesses) state.macroprocesses = [];

          const idx = state.macroprocesses.findIndex(x => x.id === id);
          const mp = {
              id,
              type,
              name,
              owner,
              objectives
          };

          if (idx >= 0) state.macroprocesses[idx] = mp;
          else state.macroprocesses.push(mp);

          saveState();
          selectedMacroprocessId = id;

          renderMacroprocessMap();
          renderMacroprocessList();
      }

      function highlightSelectedMPRow() {
          document.querySelectorAll("#mpTbody tr").forEach(tr => {
              tr.classList.toggle("mp-row-selected", selectedMacroprocessId && tr.dataset.mpId === selectedMacroprocessId);
          });
      }

      function renderMacroprocessList() {
          const tb = $("mpTbody");
          if (!tb) return;

          const q = ($("mpSearch")?.value || "").trim().toLowerCase();

          const items = (state.macroprocesses || [])
              .slice()
              .sort((a, b) => a.id.localeCompare(b.id))
              .filter(mp => {
                  const hay = `${mp.id} ${mp.type} ${mpTypeLabel(mp.type)} ${mp.name} ${mp.owner || ""}`.toLowerCase();
                  return !q || hay.includes(q);
              });

          tb.innerHTML = "";

          items.forEach(mp => {
              const tr = document.createElement("tr");
              tr.dataset.mpId = mp.id;

              tr.innerHTML = `
		  <td class="mono fw-semibold">${escapeHtml(mp.id)}</td>
		  <td>${escapeHtml(mpTypeLabel(mp.type))}</td>
		  <td>${escapeHtml(mp.name)}</td>
		  <td>${escapeHtml(mp.owner || "‚Äî")}</td>
		  <td class="nowrap">
			<button class="btn btn-sm btn-outline-primary" data-edit-mp="${escapeHtml(mp.id)}">√âditer</button>
		  </td>
		`;

              // clic sur la ligne => ouvrir la fiche
              tr.addEventListener("click", (e) => {
                  // √©viter double d√©clenchement quand on clique le bouton
                  if (e.target?.closest("button")) return;
                  editMacroprocess(mp.id);
              });

              tb.appendChild(tr);
          });

          tb.querySelectorAll("button[data-edit-mp]").forEach(btn => {
              btn.addEventListener("click", (e) => {
                  e.stopPropagation();
                  editMacroprocess(btn.getAttribute("data-edit-mp"));
              });
          });

          highlightSelectedMPRow();
      }

      // processes
      let selectedProcessId = null;
      let selectedMacroprocessForProcessTab = null;

      // Filter list (right) ------------------------------------------
      function badgeClass(level) {
          switch (level) {
              case "Critique":
                  return "text-bg-danger";
              case "√âlev√©":
                  return "text-bg-warning";
              case "Significatif":
                  return "text-bg-primary";
              case "Mod√©r√©":
                  return "text-bg-info";
              case "Faible":
                  return "text-bg-success";
              default:
                  return "text-bg-secondary";
          }
      }

      function highlightSelectedInList() {
          document.querySelectorAll(".risk-item").forEach(el => {
              const id = el.dataset.riskId;
              el.classList.toggle("selected", selectedRiskId && id === selectedRiskId);
          });
      }

      function renderRiskList() {
          const list = $("riskList");
          const q = ($("filterSearch").value || "").trim().toLowerCase();

          const computed = state.risks.map(computeRisk);
          list.innerHTML = "";

          computed.forEach(r => {
              const hay = `${r.id} ${r.domain} ${r.title}`.toLowerCase();
              if (q && !hay.includes(q)) return;

              const item = document.createElement("div");
              item.className = "risk-item";
              item.dataset.riskId = r.id;

              const chk = document.createElement("input");
              chk.type = "checkbox";
              chk.className = "form-check-input mt-1";
              chk.checked = (r.visible !== false);

              chk.addEventListener("change", () => {
                  const target = state.risks.find(x => x.id === r.id);
                  if (target) target.visible = chk.checked;
                  saveState();
                  renderMatrix();
                  updateCounters();
              });

              const meta = document.createElement("div");
              meta.className = "meta";
              meta.innerHTML = `
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="title"><span class="mono">${escapeHtml(r.id)}</span> ‚Äì ${escapeHtml(r.title)}</div>
            <span class="badge ${badgeClass(r.level)} tag">${escapeHtml(r.level)}</span>
          </div>
          <div class="sub">${escapeHtml(r.domain)} ¬∑ ${escapeHtml(r.step || "")} ¬∑ <span class="mono">${r.p}√ó${r.i}=${r.score}</span></div>
        `;

              meta.addEventListener("click", () => editRisk(r.id));

              item.appendChild(chk);
              item.appendChild(meta);

              list.appendChild(item);
          });

          highlightSelectedInList();
      }

      function setAllVisible(value) {
          state.risks = state.risks.map(r => ({
              ...r,
              visible: value
          }));
          saveState();
          renderAll();
      }

      function computeDomainMastery() {
          const risks = (state.risks || []).map(computeRisk);

          const byDomain = {};

          risks.forEach(r => {
              const d = r.domain || "Non d√©fini";
              if (!byDomain[d]) {
                  byDomain[d] = {
                      domain: d,
                      total: 0,
                      critHigh: 0,
                      mastered: 0,
                      processes: new Set()
                  };
              }

              const dom = byDomain[d];
              dom.total++;

              if (r.level === "Critique" || r.level === "√âlev√©") {
                  dom.critHigh++;
              }

              if (r.control?.implemented && r.scoreRes <= 7) {
                  dom.mastered++;
              }

              if (r.processId) dom.processes.add(r.processId);
          });

          // Finalise
          return Object.values(byDomain).map(d => {
              d.rate = d.total ? Math.round((d.mastered / d.total) * 100) : 0;
              d.processes = Array.from(d.processes);
              d.level = domainLevel(d);
              return d;
          });
      }

      function domainLevel(d) {
          if (d.critHigh > 0 && d.rate < 50) return "Faible";
          if (d.rate < 80) return "√Ä renforcer";
          return "Ma√Ætris√©";
      }

      function renderDomainSummaryCards(domains) {
          const c = document.getElementById("domainSummaryCards");
          if (!c) return;

          c.innerHTML = "";

          domains.forEach(d => {
              const color =
                  d.level === "Ma√Ætris√©" ? "success" :
                  d.level === "√Ä renforcer" ? "warning" : "danger";

              c.innerHTML += `
		  <div class="col-md-3">
			<div class="card border-${color} h-100">
			  <div class="card-body">
				<div class="fw-semibold">${escapeHtml(d.domain)}</div>
				<div class="display-6">${d.rate}%</div>
				<div class="small text-muted">
				  ${d.mastered}/${d.total} risques ma√Ætris√©s
				</div>
				<span class="badge text-bg-${color} mt-2">${d.level}</span>
			  </div>
			</div>
		  </div>
		`;
          });
      }

      function renderDomainTable(domains) {
          const tb = document.getElementById("domainTableBody");
          if (!tb) return;

          tb.innerHTML = "";

          domains.forEach(d => {
              const color =
                  d.level === "Ma√Ætris√©" ? "success" :
                  d.level === "√Ä renforcer" ? "warning" : "danger";

              tb.innerHTML += `
		  <tr>
			<td class="fw-semibold">${escapeHtml(d.domain)}</td>
			<td>${d.total}</td>
			<td>${d.critHigh}</td>
			<td>${d.mastered}</td>
			<td>${d.rate}%</td>
			<td><span class="badge text-bg-${color}">${d.level}</span></td>
			<td class="small mono">
			  ${d.processes.join(", ") || "‚Äî"}
			</td>
		  </tr>
		`;
          });
      }

      function renderDomainMasteryTab() {
          const domains = computeDomainMastery();
          renderDomainSummaryCards(domains);
          renderDomainTable(domains);
      }

      function svgElementToPngDataUrl(svgEl, targetWidth = 1200) {
          if (!svgEl) return null;

          // 1) S√©rialiser le SVG
          const svg = svgEl.cloneNode(true);

          // Nettoyage l√©ger (events)
          svg.querySelectorAll("*").forEach(el => {
              el.removeAttribute("onclick");
              el.removeAttribute("ondblclick");
              el.removeAttribute("onmouseover");
              el.removeAttribute("onmouseout");
          });

          // 2) Dimensions
          const vb = svg.getAttribute("viewBox") || "0 0 1200 720";
          const [, , vbW, vbH] = vb.split(/\s+/).map(Number);
          const width = targetWidth;
          const height = Math.round((vbH / vbW) * width);

          // 3) Canvas
          const canvas = document.createElement("canvas");
          canvas.width = width;
          canvas.height = height;

          // Fond blanc (important pour Word)
          const ctx = canvas.getContext("2d");
          ctx.fillStyle = "#ffffff";
          ctx.fillRect(0, 0, width, height);

          // 4) Rendu via canvg
          const svgText = new XMLSerializer().serializeToString(svg);
          const v = window.canvg.Canvg.fromString(ctx, svgText, {
              ignoreAnimation: true,
              ignoreMouse: true
          });
          v.render();

          // 5) PNG base64
          return canvas.toDataURL("image/png");
      }

      function cloneMacroprocessSvgForWord() {
          const src = document.getElementById("mpMap");
          if (!src) {
              return "<p><em>Cartographie des macroprocessus non disponible.</em></p>";
          }

          // Clone profond
          const clone = src.cloneNode(true);

          // Nettoyage : retirer IDs dupliqu√©s / events
          clone.removeAttribute("id");
          clone.querySelectorAll("*").forEach(el => {
              el.removeAttribute("onclick");
              el.removeAttribute("ondblclick");
              el.removeAttribute("onmouseover");
              el.removeAttribute("onmouseout");
              el.style.cursor = "default";
          });

          // Forcer taille compatible Word
          clone.setAttribute("width", "100%");
          clone.setAttribute("height", "350");
          clone.setAttribute("viewBox", src.getAttribute("viewBox") || "0 0 1200 400");

          return clone.outerHTML;
      }


      // Register (table) ---------------------------------------------
      function renderRegister() {
          const q = ($("search").value || "").trim().toLowerCase();
          const lvl = $("filterLevel").value;

          const computed = state.risks.map(computeRisk);

          const filtered = computed.filter(r => {
              const hay = `${r.id} ${r.domain} ${r.title} ${r.justification || ""} ${(r.control?.name || "")}`.toLowerCase();
              const okQ = !q || hay.includes(q);
              const okL = !lvl || r.level === lvl;
              return okQ && okL;
          });

          const tb = $("tbody");
          tb.innerHTML = "";

          filtered.forEach(r => {
              const ctrlTxt = (r.control?.name || "").trim() || "‚Äî";
              const ctrlFlag = r.control?.implemented ? `<span class="badge text-bg-success ms-1">effectif</span>` : `<span class="badge text-bg-secondary ms-1">pr√©vu</span>`;
              const residualTxt = (r.control?.implemented) ?
                  `${r.pRes}√ó${r.iRes}=${r.scoreRes} (${r.levelRes})` :
                  "‚Äî";

              const tr = document.createElement("tr");
              tr.innerHTML = `
          <td class="mono fw-semibold">${r.id}</td>
          <td>${escapeHtml(r.domain)}</td>
          <td>
            <div class="fw-semibold">${escapeHtml(r.title)}</div>
            <div class="small-muted">${escapeHtml(r.step || "")}</div>
          </td>
          <td class="mono">${r.p}√ó${r.i}=${r.score}</td>
          <td><span class="badge ${badgeClass(r.level)}">${escapeHtml(r.level)}</span></td>
          <td>
            <div>${escapeHtml(ctrlTxt)} ${ctrlFlag}</div>
            <div class="small-muted">ŒîP=${r.control?.dP ?? 0}, ŒîI=${r.control?.dI ?? 0}</div>
          </td>
          <td class="mono">${escapeHtml(residualTxt)}</td>
          <td class="nowrap">
            <button class="btn btn-sm btn-outline-primary me-1" data-edit="${r.id}">√âditer</button>
            <button class="btn btn-sm btn-outline-danger" data-del="${r.id}">Suppr.</button>
          </td>
        `;
              tb.appendChild(tr);
          });

          tb.querySelectorAll("button[data-edit]").forEach(b => {
              b.addEventListener("click", () => editRisk(b.dataset.edit));
          });
          tb.querySelectorAll("button[data-del]").forEach(b => {
              b.addEventListener("click", () => deleteRisk(b.dataset.del));
          });
      }

      function updateCounters() {
          const computed = state.risks.map(computeRisk);
          $("countRisks").textContent = computed.length;
          $("countCrit").textContent = computed.filter(r => r.level === "Critique").length;
          $("countHigh").textContent = computed.filter(r => r.level === "√âlev√©").length;
          $("countShown").textContent = computed.filter(r => r.visible !== false).length;
      }

      function computeMpDomainMatrix() {
          const risks = (state.risks || []).map(computeRisk);
          const processes = state.processes || [];
          const mps = state.macroprocesses || [];

          // domaines existants
          const domains = Array.from(new Set(risks.map(r => r.domain || "Non d√©fini"))).sort();

          // index processus ‚Üí macroprocessus
          const procToMp = {};
          processes.forEach(p => procToMp[p.id] = p.macroprocessId);

          // init structure
          const matrix = {};
          mps.forEach(mp => {
              matrix[mp.id] = {};
              domains.forEach(d => {
                  matrix[mp.id][d] = {
                      total: 0,
                      mastered: 0
                  };
              });
          });

          // alimentation
          risks.forEach(r => {
              const mpId = procToMp[r.processId];
              if (!mpId || !matrix[mpId]) return;

              const d = r.domain || "Non d√©fini";
              matrix[mpId][d].total++;

              if (r.control?.implemented && r.scoreRes <= 7) {
                  matrix[mpId][d].mastered++;
              }
          });

          return {
              matrix,
              domains
          };
      }

      function renderMpDomainMatrix() {
          const {
              matrix,
              domains
          } = computeMpDomainMatrix();

          const th = document.getElementById("mpDomainHeader");
          const tb = document.getElementById("mpDomainBody");
          if (!th || !tb) return;

          // Header
          th.innerHTML = `<th>Macroprocessus</th>` +
              domains.map(d => `<th>${escapeHtml(d)}</th>`).join("");

          // Body
          tb.innerHTML = "";

          Object.entries(matrix).forEach(([mpId, row]) => {
              const tr = document.createElement("tr");

              tr.innerHTML = `<td class="fw-semibold text-start mono">${mpId}</td>`;

              domains.forEach(d => {
                  const cell = row[d];
                  let level = "success";
                  if (cell.total > 0 && cell.mastered / cell.total < 0.8) level = "warning";
                  if (cell.total > 0 && cell.mastered / cell.total < 0.5) level = "danger";

                  tr.innerHTML += `
			<td>
			  ${cell.total === 0 ? "‚Äî" :
				`<span class="badge text-bg-${level}">
				  ${cell.mastered}/${cell.total}
				</span>`
			  }
			</td>`;
              });

              tb.appendChild(tr);
          });
      }

      function makeWordTable(rows) {
          const {
              Table,
              TableRow,
              TableCell,
              WidthType,
              Paragraph
          } = window.docx;

          return new Table({
              width: {
                  size: 100,
                  type: WidthType.PERCENTAGE
              },
              rows: rows.map(r =>
                  new TableRow({
                      children: r.map(c =>
                          new TableCell({
                              children: [new Paragraph(String(c))],
                          })
                      )
                  })
              )
          });
      }



      function renderAll() {
          updateCounters();
          renderMatrix();
          renderRiskList();
          renderRegister();
          renderMacroprocessMap();
          renderMacroprocessList();
          renderProcessTab?.();
          renderProceduresTab?.();
          renderMatrixProcessFilter();
          renderMatrixProcedureFilter();
          renderMpDomainMatrix();
          renderDomainMasteryTab();
      }

      // Import/export -----------------------------------------------
      function exportJSON() {
          const blob = new Blob([JSON.stringify(state, null, 2)], {
              type: "application/json"
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "controleinterne_risques_mails.json";
          a.click();
          URL.revokeObjectURL(url);
      }

      async function importJSON(file) {
          const txt = await file.text();
          const data = JSON.parse(txt);
          if (!data || !Array.isArray(data.risks)) {
              alert("JSON invalide (attendu: { risks: [...] })");
              return;
          }
          data.risks = data.risks.map(r => ({
              visible: true,
              ...r
          }));
          state = data;
          sortRisks();
          saveState();
          selectedRiskId = null;
          renderAll();
          clearForm();
      }

      function buildReviewHtml() {
          const wrap = document.createElement("div");
          wrap.className = "word-export";

          /* ========= PAGE DE GARDE ========= */
          wrap.innerHTML += `
		<h1>Revue de direction ‚Äì ISO 9001</h1>
		<p><strong>P√©rim√®tre :</strong> Syst√®me de management / contr√¥le interne</p>
		<p><strong>Date :</strong> ${new Date().toLocaleDateString()}</p>
		<div class="page-break"></div>

		<h2>Sommaire</h2>
		<ul>
		  <li>1. Cartographie des macroprocessus</li>
		  <li>2. Processus et proc√©dures</li>
		  <li>3. Matrice des risques</li>
		  <li>4. Macroprocessus √ó Domaines</li>
		  <li>5. D√©cisions de direction</li>
		</ul>
		<div class="page-break"></div>
	  `;

          /* ========= 1. CARTOGRAPHIE MACROPROCESSUS ========= */

          // === Cartographie macroprocessus (PNG) ===
          const svg = document.getElementById("mpMap");
          const pngDataUrl = svgElementToPngDataUrl(svg, 1200);

          const macroprocessPngHtml = pngDataUrl ?
              `<img src="${pngDataUrl}" style="width:100%; max-width:1200px; display:block; margin:2px auto;" />` :
              `<p><em>Cartographie indisponible.</em></p>`;
          wrap.innerHTML += `<h2>1. Cartographie des macroprocessus</h2>
		<p>
			Cette cartographie pr√©sente les macroprocessus de pilotage, m√©tier et support.
		</p>
		${macroprocessPngHtml}
		<div class="page-break"></div>
	  `;
          state.macroprocesses.forEach(mp => {
              wrap.innerHTML += `
		  <h3>${mp.id} ‚Äì ${mp.name}</h3>
		  <p>Type : ${mp.type === "P" ? "Pilotage" : mp.type === "M" ? "M√©tier" : "Support"}</p>
		  <p>Responsable : ${mp.owner || "‚Äî"}</p>
		`;
          });

          wrap.innerHTML += `<div class="page-break"></div>`;

          /* ========= 2. PROCESSUS & PROC√âDURES ========= */
          wrap.innerHTML += `<h2>2. Processus et proc√©dures</h2>`;

          state.macroprocesses.forEach((mp, idx) => {

              if (idx > 0) {
                  wrap.innerHTML += `<div class="page-break"></div>`;
              }

              wrap.innerHTML += `
			<h2>${mp.id} ‚Äì ${mp.name}</h2>
			<p><strong>Type :</strong> ${
			  mp.type === "P" ? "Pilotage" :
			  mp.type === "M" ? "M√©tier" : "Support"
			}</p>
			<p><strong>Responsable :</strong> ${mp.owner || "‚Äî"}</p>
		  `;

              state.processes
                  .filter(p => p.macroprocessId === mp.id)
                  .forEach(p => {
                      wrap.innerHTML += `<h3>${p.id} ‚Äì ${p.name}</h3>`;

                      state.procedures
                          .filter(pr => pr.processId === p.id)
                          .forEach(pr => {
                              wrap.innerHTML += `<h4>${pr.id} ‚Äì ${pr.name} (v${pr.version || "‚Äî"})</h4>
				  <table>
					<tr><th>Qui ?</th><th>Fait quoi ?</th><th>Comment ?</th><th>Risques</th></tr>
					${(pr.steps || []).map(s => `
					  <tr>
						<td>${s.who || "‚Äî"}</td>
						<td>${s.what || "‚Äî"}</td>
						<td>${s.how || "‚Äî"}</td>
						<td>${(s.riskIds || []).join(", ") || "‚Äî"}</td>
					  </tr>
					`).join("")}
				  </table>`;
                          });
                  });
          });

          wrap.innerHTML += `<div class="page-break"></div>`;

          /* ========= 3. MATRICE DES RISQUES ========= */
          wrap.innerHTML += `<h2>3. Matrice des risques</h2>`;
          wrap.innerHTML += `
		<table>
		  <tr>
			<th>Risque</th><th>Domaine</th><th>Processus</th>
			<th>Score initial</th><th>Niveau</th><th>Score r√©siduel</th><th>Statut</th>
		  </tr>
		  ${(state.risks || []).map(computeRisk).map(r => `
			<tr>
			  <td>${r.id} ‚Äì ${r.title}</td>
			  <td>${r.domain || "‚Äî"}</td>
			  <td>${r.processId || "‚Äî"}</td>
			  <td>${r.score}</td>
			  <td>${r.level}</td>
			  <td>${r.control?.implemented ? r.scoreRes : "‚Äî"}</td>
			  <td>${r.control?.implemented && r.scoreRes <= 7 ? "Ma√Ætris√©" : "√Ä renforcer"}</td>
			</tr>
		  `).join("")}
		</table>
	  `;

          wrap.innerHTML += `<div class="page-break"></div>`;

          /* ========= 4. MACROPROCESSUS √ó DOMAINES ========= */
          wrap.innerHTML += `<h2>4. Macroprocessus √ó Domaines</h2>`;

          const {
              matrix,
              domains
          } = computeMpDomainMatrix();

          wrap.innerHTML += `
		<table>
		  <tr>
			<th>Macroprocessus</th>
			${domains.map(d => `<th>${d}</th>`).join("")}
		  </tr>
		  ${Object.entries(matrix).map(([mpId, row]) => `
			<tr>
			  <td>${mpId}</td>
			  ${domains.map(d => {
				const c = row[d];
				return `<td>${c.total ? `${c.mastered}/${c.total}` : "‚Äî"}</td>`;
			  }).join("")}
			</tr>
		  `).join("")}
		</table>
	  `;

          wrap.innerHTML += `<div class="page-break"></div>`;

          /* ========= 5. DECISIONS ========= */
          wrap.innerHTML += `
		  <div class="page-break"></div>

		  <h2>5. D√©cisions de direction</h2>

		  <p>
			Cette section est destin√©e √† formaliser les d√©cisions prises lors de la revue
			de direction, conform√©ment √† la norme ISO 9001.
		  </p>

		  <table>
			<tr>
			  <th>Constat / Point examin√©</th>
			  <th>D√©cision</th>
			  <th>Responsable</th>
			  <th>√âch√©ance</th>
			</tr>
			<tr>
			  <td>&nbsp;</td><td></td><td></td><td></td>
			</tr>
			<tr>
			  <td>&nbsp;</td><td></td><td></td><td></td>
			</tr>
			<tr>
			  <td>&nbsp;</td><td></td><td></td><td></td>
			</tr>
		  </table>

		  <p><strong>Date de validation :</strong> ................................................</p>
		  <p><strong>Signature :</strong> ................................................</p>
		`;

          return wrap;
      }

      // Events -------------------------------------------------------
      ["p", "i"].forEach(id => $(id).addEventListener("input", recalcForm));

      $("btnSave").addEventListener("click", upsertRiskFromForm);
      $("btnClear").addEventListener("click", clearForm);

      $("search").addEventListener("input", renderRegister);
      $("filterLevel").addEventListener("change", renderRegister);

      $("filterSearch").addEventListener("input", renderRiskList);

      $("btnAll").addEventListener("click", () => setAllVisible(true));
      $("btnNone").addEventListener("click", () => setAllVisible(false));

      $("btnExport").addEventListener("click", exportJSON);
      $("btnImport").addEventListener("click", () => $("fileImport").click());
      $("fileImport").addEventListener("change", (e) => {
          const f = e.target.files?.[0];
          if (f) importJSON(f);
          e.target.value = "";
      });

      $("btnReset").addEventListener("click", () => {
          if (!confirm("R√©initialiser toutes les donn√©es (retour au jeu d‚Äôexemples) ?")) return;
          state = {
              risks: seedRisks()
          };
          sortRisks();
          saveState();
          selectedRiskId = null;
          renderAll();
          clearForm();
      });

      $("btnSaveMP").addEventListener("click", upsertMacroprocessFromForm);
      $("btnViewProcedures")?.addEventListener("click", () => {
          const pid = selectedProcessId;
          if (!pid) return;
          openProceduresTabForProcess(pid);
      });


      $("mpSearch").addEventListener("input", renderMacroprocessList);

      $("procMpSelect").addEventListener("change", () => {
          selectedMacroprocessForProcessTab = $("procMpSelect").value;
          renderProcessTab();
      });

      $("procSearch").addEventListener("input", renderProcessList);

      $("btnNewProcess").addEventListener("click", newProcess);
      $("btnClearProcess").addEventListener("click", clearProcessForm);

      $("btnSaveProcess").addEventListener("click", upsertProcessFromForm);
      $("btnDeleteProcess").addEventListener("click", deleteProcess);

      $("proc2ProcessSelect")?.addEventListener("change", () => {
          selectedProcessForProceduresTab = $("proc2ProcessSelect").value;
          renderProcedureList();
          clearProcedureForm();
      });

      $("proc2Search")?.addEventListener("input", renderProcedureList);

      $("btnNewProcedure")?.addEventListener("click", newProcedure);
      $("btnClearProcedure")?.addEventListener("click", clearProcedureForm);

      $("btnSaveProcedure")?.addEventListener("click", upsertProcedureFromForm);
      $("btnDeleteProcedure")?.addEventListener("click", deleteProcedure);

      $("btnAddStep")?.addEventListener("click", addStep);

      $("btnBackToProcedure")?.addEventListener("click", () => {
          if (!lastContext || lastContext.fromTab !== "tab-procedures") return;

          const {
              procedureId,
              processId
          } = lastContext;

          // Nettoyage du contexte (√©vite boucles)
          lastContext = null;

          openTab("tab-procedures");

          setTimeout(() => {
              selectedProcessForProceduresTab = processId;
              renderProceduresTab?.();
              if (procedureId) editProcedure(procedureId);
          }, 50);
      });

      $("matrixFilterProcess")?.addEventListener("change", renderMatrix);
      $("matrixFilterProcedure")?.addEventListener("change", renderMatrix);

      $("btnClearMatrixFilters")?.addEventListener("click", () => {
          $("matrixFilterProcess").value = "";
          $("matrixFilterProcedure").value = "";
          renderMatrix();
      });

      $("btnExportPdf")?.addEventListener("click", () => {
          const el = document.getElementById("tab-domains");

          const opt = {
              margin: 10,
              filename: "Revue_de_direction.pdf",
              image: {
                  type: "jpeg",
                  quality: 0.98
              },
              html2canvas: {
                  scale: 2
              },
              jsPDF: {
                  unit: "mm",
                  format: "a4",
                  orientation: "portrait"
              }
          };

          html2pdf().set(opt).from(el).save();
      });

      $("btnExportWord")?.addEventListener("click", () => {
          const html = buildReviewHtml().outerHTML;

          const blob = window.htmlDocx.asBlob(html);
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = "Revue_de_direction.docx";
          a.click();
      });



      function openTab(tabPaneId) {
          const btn = document.querySelector(`button[data-bs-target="#${tabPaneId}"]`);
          if (!btn || !window.bootstrap?.Tab) return;
          window.bootstrap.Tab.getOrCreateInstance(btn).show();
      }


      // Init ---------------------------------------------------------
      let state = loadState();
      let selectedProcedureId = null;
      let selectedProcessForProceduresTab = null;

      // Assure structure
      if (!state.procedures) state.procedures = [];

      if (!state.processes || state.processes.length === 0) {
          state.processes = [

              /* =========================
                 MPP01 ‚Äì Pilotage du contr√¥le interne
                 ========================= */
              {
                  id: "MPP01-001",
                  macroprocessId: "MPP01",
                  name: "Gouvernance du contr√¥le interne",
                  pilot: "Chef d‚Äô√©tablissement",
                  purpose: "D√©finir l‚Äôorganisation, les responsabilit√©s et les r√®gles du contr√¥le interne",
                  scope: "Ensemble des activit√©s de l‚ÄôEPLE",
                  inputs: "Textes r√©glementaires, orientations acad√©miques",
                  outputs: "R√®gles internes, d√©cisions de pilotage",
                  resources: "Instances, tableaux de bord",
                  interactions: "Direction, SGE, services",
                  kpi: "Taux de proc√©dures formalis√©es",
                  risks: "Risque de gouvernance d√©faillante",
                  docs: "Charte de contr√¥le interne"
              },
              {
                  id: "MPP01-002",
                  macroprocessId: "MPP01",
                  name: "Cartographie des risques et plan de ma√Ætrise",
                  pilot: "SGE",
                  purpose: "Identifier, √©valuer et ma√Ætriser les risques",
                  scope: "Processus administratifs et supports",
                  inputs: "Activit√©s, incidents, audits",
                  outputs: "Cartographie, plan de contr√¥le",
                  resources: "Outil risques, r√©f√©rentiels",
                  interactions: "Tous services",
                  kpi: "Nb risques critiques non ma√Ætris√©s",
                  risks: "Risque non identifi√©",
                  docs: "Cartographie des risques"
              },
              {
                  id: "MPP01-003",
                  macroprocessId: "MPP01",
                  name: "Revue de conformit√© et auditabilit√©",
                  pilot: "SGE",
                  purpose: "Garantir la conformit√© et la production de preuves",
                  scope: "Proc√©dures et enregistrements",
                  inputs: "Exigences r√©glementaires",
                  outputs: "Rapports de conformit√©",
                  resources: "Check-lists, audits",
                  interactions: "Auditeurs, services",
                  kpi: "Nb √©carts constat√©s",
                  risks: "Non-conformit√©",
                  docs: "Rapports d‚Äôaudit"
              },
              {
                  id: "MPP01-004",
                  macroprocessId: "MPP01",
                  name: "Gestion des non-conformit√©s et actions correctives",
                  pilot: "SGE",
                  purpose: "Traiter les √©carts et am√©liorer le syst√®me",
                  scope: "Tous processus",
                  inputs: "Constats, incidents",
                  outputs: "Actions correctives",
                  resources: "Plans d‚Äôactions",
                  interactions: "Services",
                  kpi: "Taux d‚Äôactions cl√¥tur√©es",
                  risks: "R√©currence des √©carts",
                  docs: "Registre NC"
              },
              {
                  id: "MPP01-005",
                  macroprocessId: "MPP01",
                  name: "Pilotage documentaire",
                  pilot: "SGE",
                  purpose: "Ma√Ætriser les documents et proc√©dures",
                  scope: "Proc√©dures et enregistrements",
                  inputs: "Documents sources",
                  outputs: "Proc√©dures valid√©es",
                  resources: "GED",
                  interactions: "Tous services",
                  kpi: "% documents √† jour",
                  risks: "Proc√©dure obsol√®te",
                  docs: "R√©f√©rentiel documentaire"
              },

              /* =========================
                 MPP02 ‚Äì Pilotage qualit√© / conformit√©
                 ========================= */
              {
                  id: "MPP02-001",
                  macroprocessId: "MPP02",
                  name: "Management de la qualit√©",
                  pilot: "Chef d‚Äô√©tablissement",
                  purpose: "Piloter la performance et la qualit√©",
                  scope: "Syst√®me qualit√©",
                  inputs: "Objectifs, indicateurs",
                  outputs: "Plans d‚Äôam√©lioration",
                  resources: "Tableaux de bord",
                  interactions: "Tous services",
                  kpi: "Atteinte des objectifs",
                  risks: "D√©rive qualit√©",
                  docs: "Politique qualit√©"
              },
              {
                  id: "MPP02-002",
                  macroprocessId: "MPP02",
                  name: "Veille r√©glementaire",
                  pilot: "SGE",
                  purpose: "Identifier et suivre les obligations",
                  scope: "R√©glementation EPLE",
                  inputs: "Textes officiels",
                  outputs: "Synth√®ses r√©glementaires",
                  resources: "Veille",
                  interactions: "Direction",
                  kpi: "Textes int√©gr√©s",
                  risks: "Obligation non identifi√©e",
                  docs: "Registre veille"
              },

              /* =========================
                 MPM01 ‚Äì Gestion administrative EPLE
                 ========================= */
              {
                  id: "MPM01-001",
                  macroprocessId: "MPM01",
                  name: "Gestion des courriels et du classement probant",
                  pilot: "SGE",
                  purpose: "Assurer tra√ßabilit√©, preuve et conformit√© des √©changes",
                  scope: "Messagerie professionnelle",
                  inputs: "Courriels entrants",
                  outputs: "Courriels class√©s et archiv√©s",
                  resources: "Messagerie, arborescence",
                  interactions: "Tous services",
                  kpi: "% mails class√©s < 30 jours",
                  risks: "Perte de preuve",
                  docs: "Proc√©dure mails"
              },
              {
                  id: "MPM01-002",
                  macroprocessId: "MPM01",
                  name: "Gestion budg√©taire et comptable",
                  pilot: "Agent comptable",
                  purpose: "Assurer l‚Äôex√©cution budg√©taire",
                  scope: "Budget EPLE",
                  inputs: "D√©cisions, commandes",
                  outputs: "Mandats, titres",
                  resources: "Op@le",
                  interactions: "Collectivit√©, fournisseurs",
                  kpi: "D√©lais de paiement",
                  risks: "Erreur comptable",
                  docs: "Proc√©dure budg√©taire"
              },

              /* =========================
                 MPM02 ‚Äì Gestion restauration
                 ========================= */
              {
                  id: "MPM02-001",
                  macroprocessId: "MPM02",
                  name: "Gestion HACCP et production repas",
                  pilot: "Chef de cuisine",
                  purpose: "Garantir la s√©curit√© alimentaire",
                  scope: "Restauration scolaire",
                  inputs: "Denr√©es",
                  outputs: "Repas conformes",
                  resources: "Cuisine, plans HACCP",
                  interactions: "Gestion, fournisseurs",
                  kpi: "Nb non-conformit√©s",
                  risks: "Risque sanitaire",
                  docs: "Plan HACCP"
              },

              /* =========================
                 MPS01 ‚Äì RH / s√©curit√© / moyens
                 ========================= */
              {
                  id: "MPS01-001",
                  macroprocessId: "MPS01",
                  name: "Gestion RH administrative",
                  pilot: "SGE",
                  purpose: "G√©rer les dossiers agents",
                  scope: "Agents EPLE",
                  inputs: "D√©cisions RH",
                  outputs: "Dossiers √† jour",
                  resources: "SIRH",
                  interactions: "Collectivit√©",
                  kpi: "Dossiers conformes",
                  risks: "Erreur RH",
                  docs: "Proc√©dure RH"
              },

              /* =========================
                 MPS02 ‚Äì Syst√®mes d‚Äôinformation
                 ========================= */
              {
                  id: "MPS02-001",
                  macroprocessId: "MPS02",
                  name: "Gestion des acc√®s et habilitations SI",
                  pilot: "R√©f√©rent num√©rique",
                  purpose: "S√©curiser l‚Äôacc√®s aux syst√®mes",
                  scope: "SI EPLE",
                  inputs: "Demandes acc√®s",
                  outputs: "Comptes habilit√©s",
                  resources: "Annuaire, outils SI",
                  interactions: "Agents",
                  kpi: "Revues d‚Äôacc√®s",
                  risks: "Acc√®s non autoris√©",
                  docs: "Charte SI"
              }
          ];

          saveState();
      }

      if (!state.processes) state.processes = [];


      sortRisks();
      recalcForm();
      renderAll();
  </script>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
